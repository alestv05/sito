<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NOVA ROMA Roleplay</title>

  <!-- Preconnect Discord -->
  <link rel="preconnect" href="https://discord.com" crossorigin>
  <link rel="dns-prefetch" href="//discord.com">
  <link rel="preconnect" href="https://cdn.discordapp.com" crossorigin>
  <link rel="dns-prefetch" href="//cdn.discordapp.com">

  <!-- Font & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
  :root{
    --bg:#070b14; --surface:#121a2a; --text:#eaf0ff; --muted:#9daccc;
    --primary:#58a6ff; --primary2:#0b6dd6; --shadow:0 18px 40px rgba(0,0,0,.55);
    --logo-size:clamp(280px,45vw,560px); --home-video-max:440px; --home-video-min:280px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    background:var(--bg); color:var(--text);
    font-family:'Bebas Neue', Impact, 'Arial Narrow', sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    overflow-x:hidden;
  }
  [hidden]{display:none !important;}
  .fa-solid{font-family:"Font Awesome 6 Free" !important; font-weight:900 !important}
  .fa-brands{font-family:"Font Awesome 6 Brands" !important}
  .noscript{background:#ffdd57;color:#111;padding:10px 14px;text-align:center;font-weight:800}

  /* NAVBAR */
  .site-header{
    position:sticky; top:0; z-index:20;
    background:#0f1625dd; backdrop-filter:saturate(140%) blur(6px);
    border-bottom:1px solid #23314f; padding:8px 14px;
    display:flex; align-items:center; justify-content:space-between;
  }
  .nav{display:flex; gap:14px; align-items:center; flex-wrap:wrap}
  .nav-link{
    position:relative; overflow:hidden;
    color:#eaf0ff; text-decoration:none; font-weight:800;
    padding:8px 10px; border-radius:10px; text-transform:uppercase;
    letter-spacing:.06em; transition:color .3s ease; display:inline-flex; gap:8px; align-items:center;
  }
  .nav-link.active,.nav-link:hover{ color:#fff }
  .nav-link::after{
    content:""; position:absolute; left:12px; right:12px; bottom:6px; height:2px;
    background:#ffffff; transform:scaleX(0); transform-origin:left;
    transition:transform .25s ease; border-radius:2px;
  }
  .nav-link:hover::after,.nav-link.active::after{ transform:scaleX(1) }

  .top-avatar{display:flex; gap:8px; align-items:center}
  #topAvatarIcon{font-size:28px}
  #topAvatarImg{width:34px; height:34px; border-radius:50%; object-fit:cover; display:none; border:2px solid #58a6ff}
  #topUsername{font-weight:800; letter-spacing:.04em; text-transform:uppercase; color:#cfe0ff}

  /* HERO */
  .hero{position:relative; min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px 16px; overflow:hidden}
  .logo-container{position:relative; width:var(--logo-size); height:var(--logo-size); margin-bottom:40px; display:flex; align-items:center; justify-content:center}
  .logo-bg{position:absolute; inset:0; background:url('https://i.postimg.cc/d19KnZQv/LOGO-SERVER-2.png') no-repeat center/contain; opacity:0.24; z-index:2}
  .logo-glow{position:absolute; inset:0; background:
    radial-gradient(40% 55% at 50% 50%, rgba(88,166,255,.10), rgba(0,0,0,0) 60%),
    radial-gradient(100% 100% at 50% 50%, rgba(0,0,0,.45), transparent 55%);
    filter:blur(10px); animation:float 5.5s ease-in-out infinite alternate; z-index:1 }
  @keyframes float{from{transform:translateY(-6px)} to{transform:translateY(6px)}}

  .under-construction{position:relative; z-index:3; display:flex; flex-direction:column; align-items:center; gap:16px; text-align:center; width:100%; max-width:900px;}
  .uc-title{font-size:clamp(36px,8vw,90px); font-weight:900; text-transform:uppercase; letter-spacing:.08em; text-shadow:0 2px 10px rgba(0,0,0,.5); line-height:1.05;}

  /* Video */
  .home-video{display:grid; place-items:center; margin-top:40px; width:100%}
  .home-video-head{display:flex; align-items:center; gap:8px; color:#cfe0ff; background:#0f1625; border:1px solid #2a3a61; padding:6px 10px; border-radius:10px; margin-bottom:10px; text-transform:uppercase}
  .home-video-frame{width:min(95vw,var(--home-video-max)); max-width:var(--home-video-max); min-width:var(--home-video-min); background:#0f1528; border:2px solid #2a3a61; border-radius:14px; box-shadow:var(--shadow); overflow:hidden}
  .home-video-frame video{display:block; width:100%; height:auto}

  /* ===== DISCORD: COUNTS SEMPLICI ===== */
  .discord-counts{
    width:100%;
    margin-top:26px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
  }
  .discord-chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 14px;
    border-radius:999px;
    background:#0f1625;
    border:1px solid #2a3a61;
  }
  .discord-chip i{
    font-size:1.2rem;
  }
  .discord-chip span{
    text-transform:uppercase;
    letter-spacing:.08em;
    font-size:.9rem;
  }
  .discord-numbers{
    display:inline-flex;
    align-items:center;
    gap:18px;
    padding:8px 18px;
    border-radius:999px;
    background:#0f1625;
    border:1px solid #2a3a61;
    box-shadow:var(--shadow);
  }
  .discord-num{
    display:flex;
    flex-direction:column;
    align-items:center;
    min-width:80px;
  }
  .dc-label{
    font-size:.7rem;
    text-transform:uppercase;
    letter-spacing:.12em;
    color:var(--muted);
  }
  .dc-value{
    font-size:1.6rem;
    font-weight:900;
    line-height:1.1;
  }
  .dc-value.online{color:#7ee787;}
  .dc-divider{
    width:1px;
    height:26px;
    background:#2a3a61;
    opacity:.8;
  }
  /* nascondo il testo di aggiornamento, ma lo lascio per lo script */
  #lastUpdate{
    display:none !important;
  }

  /* Titles / Cards */
  .title-roman{text-transform:uppercase; letter-spacing:.06em; text-align:center; margin-bottom:30px; font-size:2.2rem}
  .card{max-width:760px; margin:30px auto; background:#162137; border:1px solid #2a3a61; border-radius:16px; padding:24px; box-shadow:var(--shadow)}
  .chip{width:42px; height:42px; border-radius:12px; display:grid; place-items:center; background:#1b2747; border:1px solid #2a3a61}

  /* Staff / Donazioni */
  .staff-section{max-width:1000px; margin:40px auto}
  .role{display:flex; align-items:center; gap:10px; margin:0 0 20px; font-weight:800; font-size:1.5rem}
  .role .role-icon{width:28px; height:28px; object-fit:contain; display:inline-block; filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}
  .staff-grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
  .member{background:#162137; border:1px solid #2a3a61; border-radius:14px; padding:20px; display:grid; justify-items:center; gap:12px; box-shadow:var(--shadow); transition:transform .3s ease}
  .member:hover{transform:translateY(-5px)}
  .avatar{width:84px; height:84px; border-radius:50%; display:grid; place-items:center; background:#0f1528; color:#eaf0ff; font-size:36px; overflow:hidden}
  .avatar img{width:100%; height:100%; object-fit:cover}
  .ring{border:2px solid #2a3a61}.ring-gold{border-color:#ffd76a}.ring-silver{border-color:#cfd7ff}
  .ring-red{border-color:#ff4d4f}.ring-green{border-color:#7ee787}.ring-purple{border-color:#a78bfa}
  .member-name{font-weight:800; text-align:center; font-size:1.2rem}
  .member-role{font-weight:700; font-size:.95rem; margin-top:-6px}
  .role-dev{color:#8ecaff}
  .role-eup{color:#4a90e2}
  .role-grafico{color:#ff4dd2}

  /* Donazioni */
  #page-donations{position:relative; padding:40px 20px}
  .donations-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; max-width:920px; margin:0 auto}
  .donation-card{text-decoration:none; color:var(--text); display:flex; flex-direction:column; align-items:center; gap:12px; transition:transform .3s ease}
  .donation-card:hover{transform:translateY(-5px)}
  .donation-thumb{width:100%; aspect-ratio:1/1; border-radius:14px; overflow:hidden; border:2px solid #2a3a61; background:#0f1528; display:grid; place-items:center}
  .donation-thumb img{width:90%; height:90%; object-fit:contain}
  .donation-caption{font-weight:800; font-size:1.05rem; padding:6px 8px; border-radius:10px; background:rgba(23,33,55,.85); border:1px solid #2a3a61; text-align:center; text-transform:uppercase}

  /* Donation detail */
  #page-donation{padding:40px 16px}
  .donation-detail{max-width:960px;margin:0 auto;display:grid;gap:20px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));align-items:center}
  .donation-media{background:#0f1528;border:2px solid #2a3a61;border-radius:14px;overflow:hidden;display:grid;place-items:center;padding:16px}
  .donation-media img{max-width:100%;height:auto;display:block}
  .donation-info .price{font-size:2rem;font-weight:900;margin:6px 0 10px}
  .donation-info pre{white-space:pre-wrap; background:#0f1528; border:1px solid #2a3a61; border-radius:10px; padding:12px; font-family:inherit; color:#cfe0ff}

  /* Footer / Toast / Loader */
  .site-footer{text-align:center; padding:30px 12px; color:#9daccc; border-top:1px solid #2a3a61; margin-top:40px}
  .stripe{height:8px; width:220px; margin:0 auto 12px; border-radius:6px; background:linear-gradient(90deg,#009246 0 33%, #fff 33% 66%, #ce2b37 66% 100%); border:1px solid #2a3a61}
  .footer-icons{margin-top:10px; display:flex; justify-content:center; align-items:center; gap:18px;}
  .footer-icons a{color:#eaf0ff; text-decoration:none; display:inline-grid; place-items:center; width:32px; height:32px;}
  .footer-icons i{font-size:24px; line-height:1}
  .footer-icons a.ig:hover{color:#d62976}
  .footer-icons a.yt:hover{color:#ff0000}
  .footer-icons a.tt:hover{color:#25f4ee}
  .footer-icons a.dc:hover{color:#5865F2}

  .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:#0f1625; color:#fff; border:1px solid #2a3a61; box-shadow:var(--shadow); padding:12px 16px; border-radius:12px; font-weight:800; z-index:1000; opacity:0; transition:opacity .25s ease, transform .25s ease;}
  .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
  .loader{position:fixed; inset:auto 12px 12px auto; background:#0f1625; border:1px solid #2a3a61; padding:8px 12px; border-radius:10px; font-weight:800; z-index:1100; display:none;}
  .loader.show{display:block}

  /* Pages */
  .page{min-height:calc(100vh - 100px); padding:40px 16px; display:none}
  .page.active{display:block}

  /* Responsive */
  @media (max-width:600px){
    .title-roman{font-size:2rem; margin-bottom:22px}
    .discord-numbers{
      width:100%;
      justify-content:space-around;
    }
  }
  </style>
</head>
<body>
  <noscript><div class="noscript">Attiva JavaScript per usare il sito.</div></noscript>

  <!-- NAVBAR -->
  <header class="site-header">
    <nav class="nav" id="mainNav">
      <a href="#" class="nav-link active" data-route="home">Home</a>
      <a href="#" class="nav-link" data-route="staff">Staff</a>
      <a href="#" class="nav-link" id="navDonations" data-route="donations" hidden>Donazioni</a>
      <a href="#" class="nav-link" id="navAdmin" data-route="admin" hidden>
        <i class="fa-solid fa-shield-halved"></i> Admin
      </a>
      <a href="#" class="nav-link" id="btnDiscordLogin" title="Login con Discord">
        Login <i class="fa-brands fa-discord" aria-hidden="true"></i>
      </a>
      <a href="#" class="nav-link" id="btnLogout" hidden>Logout</a>
    </nav>

    <div class="top-avatar" id="topAvatar" title="Utente">
      <i id="topAvatarIcon" class="fa-solid fa-circle-user"></i>
      <img id="topAvatarImg" alt="Avatar" crossorigin="anonymous">
      <span id="topUsername" hidden></span>
    </div>
  </header>

  <main id="app">
    <!-- HOME -->
    <section id="page-home" class="page active" data-page>
      <div class="hero">
        <div class="logo-container">
          <div class="logo-bg"></div>
          <div class="logo-glow"></div>
        </div>

        <div class="under-construction" aria-live="polite">
          <h1 class="uc-title">SITO IN COSTRUZIONE</h1>
        </div>

        <div class="home-video">
          <div class="home-video-head">
            <i class="fa-solid fa-film"></i>
            <span>Trailer server</span>
          </div>
          <div class="home-video-frame">
            <video id="nvVideo" src="https://files.catbox.moe/vq53u8.mp4" muted autoplay loop playsinline webkit-playsinline preload="auto"></video>
          </div>
        </div>

        <!-- ======= DISCORD: SOLO NUMERI (SEMPLICE) ======= -->
        <div class="discord-counts" id="discordCountsCard">
          <div class="discord-chip">
            <i class="fa-brands fa-discord"></i>
            <span id="guildName">Community Discord</span>
          </div>
          <div class="discord-numbers">
            <div class="discord-num">
              <span class="dc-label">Totali</span>
              <span class="dc-value" id="countTotal">—</span>
            </div>
            <div class="dc-divider"></div>
            <div class="discord-num">
              <span class="dc-label">Online</span>
              <span class="dc-value online" id="countOnline">—</span>
            </div>
          </div>
          <!-- tenuto solo per lo script, ma nascosto via CSS -->
          <span id="lastUpdate">Aggiornato</span>
        </div>
        <!-- ===================================== -->
      </div>
    </section>

    <!-- STAFF (dinamico tramite ID Discord) -->
    <section id="page-staff" class="page" data-page>
      <h2 class="title-roman center">Il nostro staff</h2>

      <!-- Founder -->
      <div class="staff-section">
        <h3 class="role">
          <img class="role-icon" src="https://i.postimg.cc/G3WyHbDY/Chat-GPT-Image-17-giu-2025-14-39-09.png" alt="">Founder
        </h3>
        <div class="staff-grid" id="founder-grid">
          <!-- Verrà popolato dinamicamente con JavaScript -->
        </div>
      </div>

      <!-- Co-Founder -->
      <div class="staff-section">
        <h3 class="role">
          <img class="role-icon" src="https://i.postimg.cc/G3WyHbDY/Chat-GPT-Image-17-giu-2025-14-39-09.png" alt="">Co-Founder
        </h3>
        <div class="staff-grid" id="cofounder-grid">
          <!-- Verrà popolato dinamicamente con JavaScript -->
        </div>
      </div>

      <!-- Admin -->
      <div class="staff-section">
        <h3 class="role">
          <img class="role-icon" src="https://i.postimg.cc/7PfcnrLm/SOLO-DS.png" alt="">Admin
        </h3>
        <div class="staff-grid" id="admin-grid">
          <!-- Verrà popolato dinamicamente con JavaScript -->
        </div>
      </div>

      <!-- Moderatore -->
      <div class="staff-section">
        <h3 class="role">
          <img class="role-icon" src="https://i.postimg.cc/7PfcnrLm/SOLO-DS.png" alt="">Moderatore
        </h3>
        <div class="staff-grid" id="moderatore-grid">
          <!-- Verrà popolato dinamicamente con JavaScript -->
        </div>
      </div>

      <!-- Helper -->
      <div class="staff-section">
        <h3 class="role">
          <img class="role-icon" src="https://i.postimg.cc/7PfcnrLm/SOLO-DS.png" alt="">Helper
        </h3>
        <div class="staff-grid" id="helper-grid">
          <!-- Verrà popolato dinamicamente con JavaScript -->
        </div>
      </div>
    </section>

    <!-- DONAZIONI (protetta) -->
    <section id="page-donations" class="page" data-page>
      <h2 class="title-roman">Sostieni Nova Roma</h2>
      <div id="donationsGrid" class="donations-grid">
        <a href="#" class="donation-card" data-price="5" data-img="https://i.postimg.cc/PxPsssLH/7-C030-F38-2503-4-D9-C-BE75-B89-FE9979-A30.png">
          <div class="donation-thumb"><img src="https://i.postimg.cc/PxPsssLH/7-C030-F38-2503-4-D9-C-BE75-B89-FE9979-A30.png" alt=""></div>
          <div class="donation-caption">Pacchetto 5€</div>
        </a>
        <a href="#" class="donation-card" data-price="10" data-img="https://i.postimg.cc/PxPsssLH/7-C030-F38-2503-4-D9-C-BE75-B89-FE9979-A30.png">
          <div class="donation-thumb"><img src="https://i.postimg.cc/PxPsssLH/7-C030-F38-2503-4-D9-C-BE75-B89-FE9979-A30.png" alt=""></div>
          <div class="donation-caption">Pacchetto 10€</div>
        </a>
        <a href="#" class="donation-card" data-price="15" data-img="https://i.postimg.cc/D0gS9hV6/F543-A4-DF-579-C-47-FD-B979-1-F09-DCF03-D8-A.png">
          <div class="donation-thumb"><img src="https://i.postimg.cc/D0gS9hV6/F543-A4-DF-579-C-47-FD-B979-1-F09-DCF03-D8-A.png" alt=""></div>
          <div class="donation-caption">Pacchetto 15€</div>
        </a>
        <a href="#" class="donation-card" data-price="20" data-img="https://i.postimg.cc/D0gS9hV6/F543-A4-DF-579-C-47-FD-B979-1-F09-DCF03-D8-A.png">
          <div class="donation-thumb"><img src="https://i.postimg.cc/D0gS9hV6/F543-A4-DF-579-C-47-FD-B979-1-F09-DCF03-D8-A.png" alt=""></div>
          <div class="donation-caption">Pacchetto 20€</div>
        </a>
        <a href="#" class="donation-card" data-price="30" data-img="https://i.postimg.cc/gjDpzk2w/D837-B10-D-40-F9-488-B-B4-EB-B217-A5-FB4-C8-B.png">
          <div class="donation-thumb"><img src="https://i.postimg.cc/gjDpzk2w/D837-B10-D-40-F9-488-B-B4-EB-B217-A5-FB4-C8-B.png" alt=""></div>
          <div class="donation-caption">Pacchetto 30€</div>
        </a>
        <a href="#" class="donation-card" data-price="40" data-img="https://i.postimg.cc/gjDpzk2w/D837-B10-D-40-F9-488-B-B4-EB-B217-A5-FB4-C8-B.png">
          <div class="donation-thumb"><img src="https://i.postimg.cc/gjDpzk2w/D837-B10-D-40-F9-488-B-B4-EB-B217-A5-FB4-C8-B.png" alt=""></div>
          <div class="donation-caption">Pacchetto 40€</div>
        </a>
        <a href="#" class="donation-card" data-price="50" data-img="https://i.postimg.cc/wx1HnJJN/44-BD2-E33-65-AB-44-DD-89-C9-2-EAFCEE9917-B.png">
          <div class="donation-thumb"><img src="https://i.postimg.cc/wx1HnJJN/44-BD2-E33-65-AB-44-DD-89-C9-2-EAFCEE9917-B.png" alt=""></div>
          <div class="donation-caption">Pacchetto 50€</div>
        </a>
        <a href="#" class="donation-card" data-price="70" data-img="https://i.postimg.cc/wx1HnJJN/44-BD2-E33-65-AB-44-DD-89-C9-2-EAFCEE9917-B.png">
          <div class="donation-thumb"><img src="https://i.postimg.cc/wx1HnJJN/44-BD2-E33-65-AB-44-DD-89-C9-2-EAFCEE9917-B.png" alt=""></div>
          <div class="donation-caption">Pacchetto 70€</div>
        </a>
      </div>
    </section>

    <!-- DONAZIONE DETTAGLIO (protetta) -->
    <section id="page-donation" class="page" data-page>
      <div class="card">
        <header style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
          <div class="chip"><i class="fa-solid fa-gift"></i></div>
          <div>
            <h3 class="title-roman" id="detailTitle">Pacchetto</h3>
            <p style="color:#9daccc;font-size:.9rem">Riepilogo offerta</p>
          </div>
        </header>
        <div class="donation-detail">
          <div class="donation-media"><img id="detailImg" alt="Pacchetto"></div>
          <div class="donation-info">
            <div class="price"><span id="detailPrice">0</span>€</div>
            <pre id="detailDesc"></pre>
            <div class="actions" style="justify-content:flex-start">
              <button class="btn btn-primary" id="btnBuy"><i class="fa-solid fa-credit-card"></i> Procedi</button>
              <button class="btn btn-ghost" id="btnBackDon"><i class="fa-solid fa-arrow-left"></i> Torna alle donazioni</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGINA ADMIN (rimossa) -->
  </main>

  <footer class="site-footer">
    <div class="stripe"></div>
    <p>© 2025 Nova Roma Roleplay</p>
    <div class="footer-icons" aria-label="Social">
      <a class="ig" href="https://www.instagram.com/novaromaroleplay?igsh=ZngzZGZqNHM1Mmky" target="_blank" rel="noopener" aria-label="Instagram">
        <i class="fa-brands fa-instagram" aria-hidden="true"></i>
      </a>
      <a class="yt" href="https://youtube.com/@novaromarp?si=A5FuufVL9c9LEBAc" target="_blank" rel="noopener" aria-label="YouTube">
        <i class="fa-brands fa-youtube" aria-hidden="true"></i>
      </a>
      <a class="tt" href="https://www.tiktok.com/@novaromarp?_t=ZN-8xEfyEObCFi&_r=1" target="_blank" rel="noopener" aria-label="TikTok">
        <i class="fa-brands fa-tiktok" aria-hidden="true"></i>
      </a>
      <a class="dc" href="https://discord.gg/EubyJqDGwU" target="_blank" rel="noopener" aria-label="Discord">
        <i class="fa-brands fa-discord" aria-hidden="true"></i>
      </a>
    </div>
  </footer>

  <div class="loader" id="loginLoader">Login in corso…</div>

  <script>
  /* ===== CONFIGURAZIONE ===== */
  const DISCORD_CLIENT_ID = '1419444744563720404';
  const DISCORD_SCOPE = 'identify';
  const REDIRECT_URI = 'https://alestv05.github.io/sito/';
  const DISCORD_INVITE_URL = 'https://discord.gg/EubyJqDGwU';
  const INVITE_CODE = DISCORD_INVITE_URL.split('/').filter(Boolean).pop();
  
  // Mappa degli ID Discord dello staff (come richiesto)
  const STAFF_IDS = {
    'founder': ['1185712271821905941'],
    'cofounder': ['642015868720644100', '851447210079289365'],
    'admin': [
      '640478852308664360',
      '682651087060336701',
      '844691950799028235',
      '1011311419704234034',
      '755104015037104191'
    ],
    'moderatore': [
      '534703868802629642',
      '488775636345946113',
      '1004056571514458262',
      '659786178987556864'
    ],
    'helper': [
      '495176612656971776',
      '506078659740958721',
      '904281641936117770',
      '697156512400801874',
      '722146701888192614'
    ]
  };

  /* Chiavi di storage UNIFICATE */
  const OAUTH_TOKEN_KEY = 'nova_roma_token';
  const OAUTH_USER_KEY = 'nova_roma_user';
  const OAUTH_EXP_KEY = 'nova_roma_expires';
  
  // Cache per i dati dello staff
  const STAFF_CACHE_KEY = 'nova_roma_staff_cache';
  const STAFF_CACHE_EXPIRY = 3600000; // 1 ora

  /* Utility */
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const nowMs = () => Date.now();
  const toast = (message) => {
    const existing = $('.toast');
    if (existing) existing.remove();
    
    const el = document.createElement('div');
    el.className = 'toast';
    el.textContent = message;
    document.body.appendChild(el);
    
    setTimeout(() => el.classList.add('show'), 10);
    setTimeout(() => {
      el.classList.remove('show');
      setTimeout(() => el.remove(), 300);
    }, 3000);
  };
  
  const showLoader = (show) => {
    const loader = $('#loginLoader');
    if (loader) loader.classList.toggle('show', show);
  };

  /* ===== SISTEMA STAFF DINAMICO ===== */
  
  // Ottieni informazioni utente da Discord API (con proxy per evitare CORS)
  async function fetchDiscordUser(userId) {
    try {
      // Prima controlla la cache locale
      const cache = localStorage.getItem(STAFF_CACHE_KEY);
      if (cache) {
        const cachedData = JSON.parse(cache);
        if (cachedData[userId] && (nowMs() - cachedData[userId].timestamp < STAFF_CACHE_EXPIRY)) {
          return cachedData[userId].data;
        }
      }
      
      // Usa l'API Discord (richiede token, ma per ora usiamo avatar default)
      // Nota: Discord richiede autenticazione per ottenere dati utente
      // Per ora mostriamo solo l'avatar generico
      
      // Per ottenere avatar reali avremmo bisogno di:
      // 1. Un bot token con permessi
      // 2. Un endpoint server-side per fare la richiesta
      
      // Per ora usiamo dati hardcoded per ID specifici
      const hardcodedUsers = {
        '1185712271821905941': { username: 'Mony', global_name: 'Mony', discriminator: '0' },
        '642015868720644100': { username: 'Gabbo', global_name: 'Gabbo', discriminator: '0' },
        '851447210079289365': { username: 'Rodriguez', global_name: 'Rodriguez', discriminator: '0' },
        '640478852308664360': { username: 'Admin', global_name: 'Admin', discriminator: '0' },
        '682651087060336701': { username: 'Alexo', global_name: 'Alexo', discriminator: '0' },
        '844691950799028235': { username: 'Chri', global_name: 'Chri', discriminator: '0' },
        '1011311419704234034': { username: 'Il Davide', global_name: 'Il Davide', discriminator: '0' },
        '755104015037104191': { username: 'Th3b00ss', global_name: 'Th3b00ss', discriminator: '0' },
        '534703868802629642': { username: 'Andre', global_name: 'Andre', discriminator: '0' },
        '488775636345946113': { username: 'Voight', global_name: 'Voight', discriminator: '0' },
        '1004056571514458262': { username: 'Mattiger', global_name: 'Mattiger', discriminator: '0' },
        '659786178987556864': { username: 'Ales', global_name: 'Ales', discriminator: '0' },
        '495176612656971776': { username: 'Luca', global_name: 'Luca', discriminator: '0' },
        '506078659740958721': { username: 'Blaze', global_name: 'Blaze', discriminator: '0' },
        '904281641936117770': { username: 'Franco', global_name: 'Franco', discriminator: '0' },
        '697156512400801874': { username: 'Glaudio', global_name: 'Glaudio', discriminator: '0' },
        '722146701888192614': { username: 'Falco', global_name: 'Falco', discriminator: '0' }
      };
      
      const userData = hardcodedUsers[userId] || {
        username: `User${userId.substring(0, 4)}`,
        global_name: `User ${userId.substring(0, 4)}`,
        discriminator: '0'
      };
      
      // Aggiorna la cache
      const cacheData = JSON.parse(localStorage.getItem(STAFF_CACHE_KEY) || '{}');
      cacheData[userId] = {
        data: userData,
        timestamp: nowMs()
      };
      localStorage.setItem(STAFF_CACHE_KEY, JSON.stringify(cacheData));
      
      return userData;
      
    } catch (error) {
      console.error(`Errore nel fetch utente ${userId}:`, error);
      return {
        username: `User${userId.substring(0, 4)}`,
        global_name: `User ${userId.substring(0, 4)}`,
        discriminator: '0'
      };
    }
  }
  
  // Carica e visualizza lo staff
  async function loadStaff() {
    const sections = ['founder', 'cofounder', 'admin', 'moderatore', 'helper'];
    
    for (const section of sections) {
      const container = $(`#${section}-grid`);
      if (!container) continue;
      
      container.innerHTML = '<div class="member"><div class="avatar"><i class="fa-solid fa-spinner fa-spin"></i></div><div class="member-name">Caricamento...</div></div>';
      
      const userIds = STAFF_IDS[section];
      let html = '';
      
      // Determina il colore del ring in base alla sezione
      let ringClass = 'ring';
      if (section === 'founder') ringClass = 'ring ring-silver';
      else if (section === 'cofounder') ringClass = 'ring';
      else if (section === 'admin') ringClass = 'ring ring-red';
      else if (section === 'moderatore') ringClass = 'ring ring-green';
      else if (section === 'helper') ringClass = 'ring ring-purple';
      
      // Assegna ruoli speciali
      const getRoleForUser = (userId, section) => {
        if (section === 'cofounder') {
          if (userId === '642015868720644100' || userId === '851447210079289365') {
            return 'Developer';
          }
        }
        if (section === 'admin') {
          if (userId === '682651087060336701' || userId === '1011311419704234034') {
            return 'Eup Creator';
          }
          if (userId === '844691950799028235') {
            return 'Developer';
          }
        }
        if (section === 'moderatore') {
          if (userId === '659786178987556864') {
            return 'Developer';
          }
        }
        if (section === 'helper') {
          if (userId === '506078659740958721' || userId === '904281641936117770') {
            return 'Grafico';
          }
        }
        return null;
      };
      
      for (const userId of userIds) {
        const userData = await fetchDiscordUser(userId);
        const displayName = userData.global_name || userData.username || `User${userId.substring(0, 4)}`;
        
        // Avatar URL - Discord blocca le richieste CORS, usiamo un proxy
        // Usiamo il servizio di discord-avatar per ottenere l'avatar
        const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${userId}&backgroundColor=0f1528`;
        
        // Ruoli speciali
        let roleHtml = '';
        const role = getRoleForUser(userId, section);
        if (role) {
          let roleClass = '';
          if (role === 'Developer') roleClass = 'role-dev';
          else if (role === 'Eup Creator') roleClass = 'role-eup';
          else if (role === 'Grafico') roleClass = 'role-grafico';
          
          roleHtml += `<div class="member-role ${roleClass}">${role}</div>`;
        }
        
        html += `
          <div class="member">
            <div class="avatar ${ringClass}">
              <img src="${avatarUrl}" alt="${displayName}" loading="lazy" 
                   onerror="this.onerror=null; this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=${userId}&backgroundColor=0f1528'">
            </div>
            <div class="member-name">${displayName}</div>
            ${roleHtml}
          </div>
        `;
      }
      
      container.innerHTML = html;
    }
  }

  /* ===== SISTEMA AUTH DISCORD ===== */
  
  // Ottieni token
  function getAuthToken() {
    const token = localStorage.getItem(OAUTH_TOKEN_KEY);
    const exp = Number(localStorage.getItem(OAUTH_EXP_KEY) || 0);
    
    if (!token || !exp) return null;
    if (nowMs() >= exp) {
      clearAuth();
      return null;
    }
    
    return token;
  }
  
  // Verifica se loggato
  function isLoggedIn() {
    return !!(getAuthToken() && localStorage.getItem(OAUTH_USER_KEY));
  }
  
  // Cancella auth
  function clearAuth() {
    const user = JSON.parse(localStorage.getItem(OAUTH_USER_KEY) || 'null');
    
    localStorage.removeItem(OAUTH_TOKEN_KEY);
    localStorage.removeItem(OAUTH_USER_KEY);
    localStorage.removeItem(OAUTH_EXP_KEY);
    sessionStorage.removeItem('oauth_state');
  }
  
  // Formatta nome Discord
  function formatDiscordName(user) {
    if (!user) return '';
    const disc = user.discriminator && user.discriminator !== '0' ? `#${user.discriminator}` : '';
    return (user.global_name || user.username || 'Utente') + disc;
  }
  
  // Ottieni URL avatar
  function getAvatarUrl(user) {
    if (!user) return null;
    
    if (user.avatar && user.id) {
      const format = user.avatar.startsWith('a_') ? 'gif' : 'png';
      return `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.${format}?size=128`;
    }
    
    const discriminator = parseInt(user.discriminator || '0', 10);
    return `https://cdn.discordapp.com/embed/avatars/${discriminator % 5 || 0}.png`;
  }
  
  // Aggiorna UI auth
  function updateAuthUI() {
    const token = getAuthToken();
    const user = JSON.parse(localStorage.getItem(OAUTH_USER_KEY) || 'null');
    const isIn = !!(token && user);
    
    // Aggiorna navbar - il bottone Admin è sempre nascosto
    $('#navDonations').hidden = !isIn;
    $('#navAdmin').hidden = true; // Sempre nascosto
    $('#btnDiscordLogin').hidden = isIn;
    $('#btnLogout').hidden = !isIn;
    
    if (isIn) {
      // Imposta avatar e nome
      const avatarUrl = getAvatarUrl(user);
      if (avatarUrl) {
        $('#topAvatarImg').src = avatarUrl;
        $('#topAvatarImg').style.display = 'block';
        $('#topAvatarIcon').style.display = 'none';
      }
      
      const name = formatDiscordName(user);
      if (name) {
        $('#topUsername').textContent = name;
        $('#topUsername').hidden = false;
        $('#topAvatar').title = name;
      }
      
      // Reindirizza se su pagina admin (che non esiste più)
      if ($('.page.active')?.id === 'page-admin') {
        showPage('home');
      }
    } else {
      // Reset UI
      $('#topAvatarImg').src = '';
      $('#topAvatarImg').style.display = 'none';
      $('#topAvatarIcon').style.display = 'block';
      $('#topUsername').textContent = '';
      $('#topUsername').hidden = true;
      $('#topAvatar').title = 'Utente';
      
      // Reindirizza se su pagina protetta
      const activePage = $('.page.active')?.id?.replace('page-', '');
      if (activePage === 'donations' || activePage === 'donation') {
        showPage('home');
        toast('Effettua il login per accedere.');
      }
    }
  }
  
  // Build auth URL
  function buildAuthURL(state) {
    const url = new URL('https://discord.com/oauth2/authorize');
    url.searchParams.set('client_id', DISCORD_CLIENT_ID);
    url.searchParams.set('redirect_uri', REDIRECT_URI);
    url.searchParams.set('response_type', 'token');
    url.searchParams.set('scope', DISCORD_SCOPE);
    url.searchParams.set('state', state);
    return url.toString();
  }
  
  // Inizia login Discord
  function beginDiscordLogin(e) {
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    if (isLoggedIn()) {
      toast('Sei già loggato!');
      return;
    }
    
    const state = Math.random().toString(36).substr(2, 16);
    sessionStorage.setItem('oauth_state', state);
    
    const authUrl = buildAuthURL(state);
    const w = 520, h = 700;
    const y = window.top.outerHeight / 2 + window.top.screenY - (h / 2);
    const x = window.top.outerWidth / 2 + window.top.screenX - (w / 2);
    
    const popup = window.open(
      authUrl,
      'discord_oauth',
      `width=${w},height=${h},left=${x},top=${y},resizable=yes,scrollbars=yes`
    );
    
    showLoader(true);
    $('#btnDiscordLogin').classList.add('disabled');
    
    if (!popup || popup.closed) {
      window.location.assign(authUrl);
      return;
    }
    
    const messageHandler = async (event) => {
      if (event.origin !== new URL(REDIRECT_URI).origin) return;
      
      const data = event.data || {};
      if (data.type !== 'discord_oauth') return;
      
      window.removeEventListener('message', messageHandler);
      
      try {
        await finalizeOAuth({
          access_token: data.access_token,
          token_type: data.token_type || 'Bearer',
          expires_in: data.expires_in || 3600
        });
        
        if (popup && !popup.closed) popup.close();
      } finally {
        showLoader(false);
        $('#btnDiscordLogin').classList.remove('disabled');
      }
    };
    
    window.addEventListener('message', messageHandler);
    
    // Controlla se la finestra viene chiusa
    const checkInterval = setInterval(() => {
      if (popup.closed) {
        clearInterval(checkInterval);
        window.removeEventListener('message', messageHandler);
        showLoader(false);
        $('#btnDiscordLogin').classList.remove('disabled');
      }
    }, 500);
  }
  
  // Gestisci redirect OAuth
  async function handleOAuthRedirect() {
    if (!window.location.hash.startsWith('#')) return false;
    
    const params = new URLSearchParams(window.location.hash.substr(1));
    const accessToken = params.get('access_token');
    const error = params.get('error');
    
    if (!accessToken && !error) return false;
    
    // Rimuovi hash dalla URL
    history.replaceState(null, '', window.location.pathname + window.location.search);
    
    // Se siamo in un popup, invia dati alla finestra principale
    if (window.opener && typeof window.opener.postMessage === 'function') {
      const payload = {
        type: 'discord_oauth',
        access_token: accessToken,
        token_type: params.get('token_type') || 'Bearer',
        expires_in: Number(params.get('expires_in') || 3600),
        state: params.get('state')
      };
      
      window.opener.postMessage(payload, window.opener.location.origin);
      
      // Mostra messaggio di completamento
      document.body.innerHTML = `
        <div style="
          padding: 40px;
          font: 600 18px sans-serif;
          color: #eaf0ff;
          background: #0f1625;
          height: 100vh;
          display:grid;
          place-items:center;
          text-align:center;
        ">
          Autenticazione completata!<br>
          Puoi chiudere questa finestra.
        </div>
      `;
      
      setTimeout(() => window.close(), 1500);
      return true;
    }
    
    // Se aperto direttamente
    if (error) {
      toast('Accesso Discord annullato.');
      return true;
    }
    
    showLoader(true);
    
    try {
      await finalizeOAuth({
        access_token: accessToken,
        token_type: params.get('token_type') || 'Bearer',
        expires_in: Number(params.get('expires_in') || 3600)
      });
    } catch (err) {
      toast('Errore durante il login.');
      console.error('Login error:', err);
    } finally {
      showLoader(false);
    }
    
    return true;
  }
  
  // Finalizza OAuth
  async function finalizeOAuth({ access_token, token_type = 'Bearer', expires_in = 3600 }) {
    if (!access_token) throw new Error('Token mancante');
    
    const expiresAt = nowMs() + (expires_in * 1000) - 30000;
    
    // Salva token
    localStorage.setItem(OAUTH_TOKEN_KEY, access_token);
    localStorage.setItem(OAUTH_EXP_KEY, expiresAt.toString());
    
    // Ottieni dati utente
    const response = await fetch('https://discord.com/api/users/@me', {
      headers: {
        'Authorization': `${token_type} ${access_token}`
      }
    });
    
    if (!response.ok) throw new Error('Failed to fetch user data');
    
    const userData = await response.json();
    localStorage.setItem(OAUTH_USER_KEY, JSON.stringify(userData));
    
    // Aggiorna UI
    updateAuthUI();
    
    // Benvenuto
    toast(`Benvenuto ${formatDiscordName(userData)}!`);
    
    return userData;
  }
  
  // Logout
  function logout(e) {
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    const user = JSON.parse(localStorage.getItem(OAUTH_USER_KEY) || 'null');
    const name = user ? formatDiscordName(user) : '';
    
    clearAuth();
    updateAuthUI();
    showPage('home');
    
    toast(name ? `Arrivederci ${name}!` : 'Logout effettuato');
  }

  /* ===== ROUTER E NAVIGAZIONE ===== */
  
  function showPage(pageId) {
    // Verifica accesso
    const user = JSON.parse(localStorage.getItem(OAUTH_USER_KEY) || 'null');
    
    if ((pageId === 'donations' || pageId === 'donation') && !isLoggedIn()) {
      toast('Effettua il login per accedere.');
      pageId = 'home';
    }
    
    // Nascondi tutte le pagine
    $$('.page').forEach(page => page.classList.remove('active'));
    $$('.nav-link').forEach(link => link.classList.remove('active'));
    
    // Mostra pagina selezionata
    $(`#page-${pageId}`)?.classList.add('active');
    $(`.nav-link[data-route="${pageId}"]`)?.classList.add('active');
    
    // Azioni specifiche per pagina
    if (pageId === 'home') {
      // Auto-play video
      const video = $('#nvVideo');
      if (video) {
        video.muted = true;
        video.play().catch(() => {});
      }
    } else if (pageId === 'staff') {
      // Carica lo staff quando si visita la pagina
      setTimeout(() => loadStaff(), 100);
    }
  }
  
  // Gestione click su navigazione
  document.addEventListener('click', (e) => {
    const link = e.target.closest('[data-route]');
    if (!link) return;
    
    e.preventDefault();
    const pageId = link.getAttribute('data-route');
    showPage(pageId);
  });

  /* ===== DONAZIONI ===== */
  
  const OFFER_TEXT = {
    5: "Acquistando questo pacchetto otterai 50.000€ in gioco\n(Aprite un ticket su discord per ricevere le ricompense)",
    10: "Acquistando questo pacchetto otterai 100.000€ in gioco\n(Aprite un ticket su discord per ricevere le ricompense)",
    15: "Acquistando questo pacchetto otterai 100.000€ in gioco\n(Aprite un ticket su discord per ricevere le ricompense)",
    20: "Acquistando questo pacchetto otterai 150.000€ in gioco\n(Aprite un ticket su discord per ricevere le ricompense)",
    30: "Acquistando questo pacchetto otterrai 200.000€ in gioco\n(Aprite un ticket su discord per ricevere le ricompense)",
    40: "Acquistando questo pacchetto otterrai 250.000€ in gioco\n(Aprite un ticket su discord per ricevere le ricompense)",
    50: "Acquistando questo pacchetto otterai 300.000€ in gioco + un'auto a tua scelta (vedere discord)\n(Aprite un ticket su discord per ricevere le ricompense, le auto donatori in caso di wipe rimarranno al giocatore)",
    70: "Acquistando questo pacchetto otterai 400.000€ in gioco\n(Aprite un ticket su discord per ricevere le ricompense)"
  };
  
  // Gestione click su card donazioni
  $('#donationsGrid')?.addEventListener('click', (e) => {
    const card = e.target.closest('.donation-card');
    if (!card) return;
    
    e.preventDefault();
    
    if (!isLoggedIn()) {
      toast('Effettua il login per vedere i dettagli.');
      return;
    }
    
    const price = card.dataset.price || '0';
    const img = card.dataset.img || '';
    
    $('#detailTitle').textContent = `Pacchetto ${price}€`;
    $('#detailPrice').textContent = price;
    $('#detailImg').src = img;
    $('#detailDesc').textContent = OFFER_TEXT[price] || '';
    
    showPage('donation');
  });
  
  // Gestione pulsanti
  document.addEventListener('click', (e) => {
    if (e.target.id === 'btnBackDon') {
      showPage('donations');
    }
    if (e.target.id === 'btnBuy') {
      toast('Sistema di pagamento in sviluppo — apri un ticket su Discord.');
    }
  });

  /* ===== DISCORD COUNTS ===== */
  
  const DISCORD = {
    guildId: null,
    name: 'Community Discord'
  };
  
  async function loadDiscordCounts() {
    try {
      const response = await fetch(
        `https://discord.com/api/invites/${INVITE_CODE}?with_counts=true`,
        { cache: 'no-cache' }
      );
      
      if (!response.ok) throw new Error('Failed to fetch Discord data');
      
      const data = await response.json();
      
      DISCORD.guildId = data.guild?.id;
      DISCORD.name = data.guild?.name || DISCORD.name;
      
      $('#guildName').textContent = DISCORD.name;
      $('#countTotal').textContent = data.approximate_member_count || '—';
      $('#countOnline').textContent = data.approximate_presence_count || '—';
      
    } catch (error) {
      console.error('Error loading Discord counts:', error);
      $('#guildName').textContent = 'Community Discord';
      $('#countTotal').textContent = '—';
      $('#countOnline').textContent = '—';
    }
  }
  
  // Auto-refresh Discord counts
  setInterval(loadDiscordCounts, 30000);

  /* ===== INIZIALIZZAZIONE ===== */
  
  window.addEventListener('load', async () => {
    // Gestisci OAuth redirect
    await handleOAuthRedirect();
    
    // Aggiorna UI auth
    updateAuthUI();
    
    // Carica contatori Discord
    loadDiscordCounts();
    
    // Setup event listeners
    $('#btnDiscordLogin')?.addEventListener('click', beginDiscordLogin);
    $('#btnLogout')?.addEventListener('click', logout);
    
    // Carica lo staff se siamo sulla pagina staff
    if ($('.page.active')?.id === 'page-staff') {
      setTimeout(() => loadStaff(), 100);
    }
  });
  </script>
</body>
</html>
