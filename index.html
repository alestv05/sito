<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NOVA ROMA Roleplay</title>

  <!-- Preconnect Discord -->
  <link rel="preconnect" href="https://discord.com" crossorigin>
  <link rel="dns-prefetch" href="//discord.com">
  <link rel="preconnect" href="https://cdn.discordapp.com" crossorigin>
  <link rel="dns-prefetch" href="//cdn.discordapp.com">

  <!-- Font & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
  :root{
    --bg:#070b14; --surface:#121a2a; --text:#eaf0ff; --muted:#9daccc;
    --primary:#58a6ff; --primary2:#0b6dd6; --shadow:0 18px 40px rgba(0,0,0,.55);
    --logo-size:clamp(280px,45vw,560px); --home-video-max:440px; --home-video-min:280px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    background:var(--bg); color:var(--text);
    font-family:'Bebas Neue', Impact, 'Arial Narrow', sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    overflow-x:hidden;
  }
  [hidden]{display:none !important;}
  .fa-solid{font-family:"Font Awesome 6 Free" !important; font-weight:900 !important}
  .fa-brands{font-family:"Font Awesome 6 Brands" !important}
  .noscript{background:#ffdd57;color:#111;padding:10px 14px;text-align:center;font-weight:800}

  /* NAVBAR */
  .site-header{
    position:sticky; top:0; z-index:20;
    background:#0f1625dd; backdrop-filter:saturate(140%) blur(6px);
    border-bottom:1px solid #23314f; padding:8px 14px;
    display:flex; align-items:center; justify-content:space-between;
  }
  .nav{display:flex; gap:14px; align-items:center; flex-wrap:wrap}
  .nav-link{
    position:relative; overflow:hidden;
    color:#eaf0ff; text-decoration:none; font-weight:800;
    padding:8px 10px; border-radius:10px; text-transform:uppercase;
    letter-spacing:.06em; transition:color .3s ease; display:inline-flex; gap:8px; align-items:center;
  }
  .nav-link.active,.nav-link:hover{ color:#fff }
  .nav-link::after{
    content:""; position:absolute; left:12px; right:12px; bottom:6px; height:2px;
    background:#ffffff; transform:scaleX(0); transform-origin:left;
    transition:transform .25s ease; border-radius:2px;
  }
  .nav-link:hover::after,.nav-link.active::after{ transform:scaleX(1) }

  .top-avatar{display:flex; gap:8px; align-items:center}
  #topAvatarIcon{font-size:28px}
  #topAvatarImg{width:34px; height:34px; border-radius:50%; object-fit:cover; display:none; border:2px solid #58a6ff}
  #topUsername{font-weight:800; letter-spacing:.04em; text-transform:uppercase; color:#cfe0ff}

  /* HERO */
  .hero{position:relative; min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px 16px; overflow:hidden}
  .logo-container{position:relative; width:var(--logo-size); height:var(--logo-size); margin-bottom:40px; display:flex; align-items:center; justify-content:center}
  .logo-bg{position:absolute; inset:0; background:url('https://i.postimg.cc/d19KnZQv/LOGO-SERVER-2.png') no-repeat center/contain; opacity:0.24; z-index:2}
  .logo-glow{position:absolute; inset:0; background:
    radial-gradient(40% 55% at 50% 50%, rgba(88,166,255,.10), rgba(0,0,0,0) 60%),
    radial-gradient(100% 100% at 50% 50%, rgba(0,0,0,.45), transparent 55%);
    filter:blur(10px); animation:float 5.5s ease-in-out infinite alternate; z-index:1 }
  @keyframes float{from{transform:translateY(-6px)} to{transform:translateY(6px)}}

  .under-construction{position:relative; z-index:3; display:flex; flex-direction:column; align-items:center; gap:16px; text-align:center; width:100%; max-width:900px;}
  .uc-title{font-size:clamp(36px,8vw,90px); font-weight:900; text-transform:uppercase; letter-spacing:.08em; text-shadow:0 2px 10px rgba(0,0,0,.5); line-height:1.05;}

  /* Video */
  .home-video{display:grid; place-items:center; margin-top:40px; width:100%}
  .home-video-head{display:flex; align-items:center; gap:8px; color:#cfe0ff; background:#0f1625; border:1px solid #2a3a61; padding:6px 10px; border-radius:10px; margin-bottom:10px; text-transform:uppercase}
  .home-video-frame{width:min(95vw,var(--home-video-max)); max-width:var(--home-video-max); min-width:var(--home-video-min); background:#0f1528; border:2px solid #2a3a61; border-radius:14px; box-shadow:var(--shadow); overflow:hidden}
  .home-video-frame video{display:block; width:100%; height:auto}

  /* ===== DISCORD: COUNTS SEMPLICI ===== */
  .discord-counts{
    width:100%;
    margin-top:26px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
  }
  .discord-chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 14px;
    border-radius:999px;
    background:#0f1625;
    border:1px solid #2a3a61;
  }
  .discord-chip i{
    font-size:1.2rem;
  }
  .discord-chip span{
    text-transform:uppercase;
    letter-spacing:.08em;
    font-size:.9rem;
  }
  .discord-numbers{
    display:inline-flex;
    align-items:center;
    gap:18px;
    padding:8px 18px;
    border-radius:999px;
    background:#0f1625;
    border:1px solid #2a3a61;
    box-shadow:var(--shadow);
  }
  .discord-num{
    display:flex;
    flex-direction:column;
    align-items:center;
    min-width:80px;
  }
  .dc-label{
    font-size:.7rem;
    text-transform:uppercase;
    letter-spacing:.12em;
    color:var(--muted);
  }
  .dc-value{
    font-size:1.6rem;
    font-weight:900;
    line-height:1.1;
  }
  .dc-value.online{color:#7ee787;}
  .dc-divider{
    width:1px;
    height:26px;
    background:#2a3a61;
    opacity:.8;
  }
  /* nascondo il testo di aggiornamento, ma lo lascio per lo script */
  #lastUpdate{
    display:none !important;
  }

  /* Titles / Cards */
  .title-roman{text-transform:uppercase; letter-spacing:.06em; text-align:center; margin-bottom:30px; font-size:2.2rem}
  .card{max-width:760px; margin:30px auto; background:#162137; border:1px solid #2a3a61; border-radius:16px; padding:24px; box-shadow:var(--shadow)}
  .chip{width:42px; height:42px; border-radius:12px; display:grid; place-items:center; background:#1b2747; border:1px solid #2a3a61}

  /* Staff / Donazioni */
  .staff-section{max-width:1000px; margin:40px auto}
  .role{display:flex; align-items:center; gap:10px; margin:0 0 20px; font-weight:800; font-size:1.5rem}
  .role .role-icon{width:28px; height:28px; object-fit:contain; display:inline-block; filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}
  .staff-grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
  .member{background:#162137; border:1px solid #2a3a61; border-radius:14px; padding:20px; display:grid; justify-items:center; gap:12px; box-shadow:var(--shadow); transition:transform .3s ease}
  .member:hover{transform:translateY(-5px)}
  .avatar{width:84px; height:84px; border-radius:50%; display:grid; place-items:center; background:#0f1528; color:#eaf0ff; font-size:36px; overflow:hidden}
  .avatar img{width:100%; height:100%; object-fit:cover}
  .ring{border:2px solid #2a3a61}.ring-gold{border-color:#ffd76a}.ring-silver{border-color:#cfd7ff}
  .ring-red{border-color:#ff4d4f}.ring-green{border-color:#7ee787}.ring-purple{border-color:#a78bfa}
  .member-name{font-weight:800; text-align:center; font-size:1.2rem}
  .member-role{font-weight:700; font-size:.95rem; margin-top:-6px}
  .role-dev{color:#8ecaff}
  .role-eup{color:#4a90e2}
  .role-grafico{color:#ff4dd2}

  /* Donazioni */
  #page-donations{position:relative; padding:40px 20px}
  .donations-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; max-width:920px; margin:0 auto}
  .donation-card{text-decoration:none; color:var(--text); display:flex; flex-direction:column; align-items:center; gap:12px; transition:transform .3s ease}
  .donation-card:hover{transform:translateY(-5px)}
  .donation-thumb{width:100%; aspect-ratio:1/1; border-radius:14px; overflow:hidden; border:2px solid #2a3a61; background:#0f1528; display:grid; place-items:center}
  .donation-thumb img{width:90%; height:90%; object-fit:contain}
  .donation-caption{font-weight:800; font-size:1.05rem; padding:6px 8px; border-radius:10px; background:rgba(23,33,55,.85); border:1px solid #2a3a61; text-align:center; text-transform:uppercase}

  /* Donation detail */
  #page-donation{padding:40px 16px}
  .donation-detail{max-width:960px;margin:0 auto;display:grid;gap:20px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));align-items:center}
  .donation-media{background:#0f1528;border:2px solid #2a3a61;border-radius:14px;overflow:hidden;display:grid;place-items:center;padding:16px}
  .donation-media img{max-width:100%;height:auto;display:block}
  .donation-info .price{font-size:2rem;font-weight:900;margin:6px 0 10px}
  .donation-info pre{white-space:pre-wrap; background:#0f1528; border:1px solid #2a3a61; border-radius:10px; padding:12px; font-family:inherit; color:#cfe0ff}

  /* Footer / Toast / Loader */
  .site-footer{text-align:center; padding:30px 12px; color:#9daccc; border-top:1px solid #2a3a61; margin-top:40px}
  .stripe{height:8px; width:220px; margin:0 auto 12px; border-radius:6px; background:linear-gradient(90deg,#009246 0 33%, #fff 33% 66%, #ce2b37 66% 100%); border:1px solid #2a3a61}
  .footer-icons{margin-top:10px; display:flex; justify-content:center; align-items:center; gap:18px;}
  .footer-icons a{color:#eaf0ff; text-decoration:none; display:inline-grid; place-items:center; width:32px; height:32px;}
  .footer-icons i{font-size:24px; line-height:1}
  .footer-icons a.ig:hover{color:#d62976}
  .footer-icons a.yt:hover{color:#ff0000}
  .footer-icons a.tt:hover{color:#25f4ee}
  .footer-icons a.dc:hover{color:#5865F2}

  .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:#0f1625; color:#fff; border:1px solid #2a3a61; box-shadow:var(--shadow); padding:12px 16px; border-radius:12px; font-weight:800; z-index:1000; opacity:0; transition:opacity .25s ease, transform .25s ease;}
  .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
  .loader{position:fixed; inset:auto 12px 12px auto; background:#0f1625; border:1px solid #2a3a61; padding:8px 12px; border-radius:10px; font-weight:800; z-index:1100; display:none;}
  .loader.show{display:block}

  /* Pages */
  .page{min-height:calc(100vh - 100px); padding:40px 16px; display:none}
  .page.active{display:block}

  /* ===== PAGINA ADMIN ===== */
  #page-admin{background:#0a0f1a}
  
  .admin-container{
    max-width:1200px;
    margin:0 auto;
    padding:20px;
  }
  
  .admin-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:30px;
    flex-wrap:wrap;
    gap:20px;
  }
  
  .admin-refresh-btn{
    background:#58a6ff;
    color:#fff;
    border:none;
    padding:10px 20px;
    border-radius:10px;
    font-weight:800;
    text-transform:uppercase;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:8px;
    transition:all .3s ease;
  }
  
  .admin-refresh-btn:hover{
    background:#0b6dd6;
    transform:translateY(-2px);
  }
  
  .admin-refresh-btn.refreshing{
    background:#9daccc;
    cursor:not-allowed;
  }
  
  .admin-refresh-btn.refreshing i{
    animation:spin 1s linear infinite;
  }
  
  @keyframes spin{
    0%{transform:rotate(0deg);}
    100%{transform:rotate(360deg);}
  }
  
  .admin-live-badge{
    background:#7ee787;
    color:#070b14;
    padding:6px 12px;
    border-radius:20px;
    font-weight:800;
    font-size:.9rem;
    display:flex;
    align-items:center;
    gap:6px;
    animation:pulse 2s infinite;
  }
  
  @keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(126, 231, 135, 0.7);}
    70%{box-shadow:0 0 0 10px rgba(126, 231, 135, 0);}
    100%{box-shadow:0 0 0 0 rgba(126, 231, 135, 0);}
  }
  
  .admin-stats-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
    gap:20px;
    margin-bottom:40px;
  }
  
  .admin-stat-card{
    background:#121a2a;
    border:1px solid #2a3a61;
    border-radius:14px;
    padding:24px;
    text-align:center;
    box-shadow:var(--shadow);
    transition:all .3s ease;
  }
  
  .admin-stat-card:hover{
    border-color:#58a6ff;
    transform:translateY(-3px);
  }
  
  .admin-stat-value{
    font-size:3rem;
    font-weight:900;
    color:#58a6ff;
    margin:10px 0;
  }
  
  .admin-stat-label{
    font-size:1.1rem;
    color:#9daccc;
    text-transform:uppercase;
    letter-spacing:.1em;
  }
  
  .admin-stat-sub{
    font-size:.85rem;
    color:#7ee787;
    margin-top:5px;
  }
  
  .admin-users-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));
    gap:20px;
    margin-top:30px;
  }
  
  .admin-user-card{
    background:#121a2a;
    border:1px solid #2a3a61;
    border-radius:14px;
    padding:20px;
    display:flex;
    align-items:center;
    gap:16px;
    transition:all .3s ease;
    position:relative;
  }
  
  .admin-user-card:hover{
    border-color:#58a6ff;
    transform:translateY(-3px);
  }
  
  .admin-user-avatar{
    width:60px;
    height:60px;
    border-radius:50%;
    object-fit:cover;
    border:2px solid #58a6ff;
  }
  
  .admin-user-info{
    flex:1;
  }
  
  .admin-user-name{
    font-size:1.2rem;
    font-weight:800;
    color:#eaf0ff;
    margin-bottom:4px;
  }
  
  .admin-user-id{
    font-size:.85rem;
    color:#9daccc;
    font-family:monospace;
  }
  
  .admin-user-status{
    display:inline-block;
    padding:4px 10px;
    border-radius:20px;
    font-size:.8rem;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.05em;
    margin-top:6px;
  }
  
  .status-online{
    background:rgba(126, 231, 135, 0.15);
    color:#7ee787;
    border:1px solid #7ee787;
  }
  
  .status-offline{
    background:rgba(157, 172, 204, 0.15);
    color:#9daccc;
    border:1px solid #9daccc;
  }
  
  .admin-user-last-seen{
    font-size:.8rem;
    color:#9daccc;
    margin-top:4px;
  }
  
  .admin-user-pulse{
    position:absolute;
    top:15px;
    right:15px;
    width:10px;
    height:10px;
    border-radius:50%;
    background:#7ee787;
    animation:pulse 2s infinite;
  }
  
  .admin-section-title{
    font-size:1.8rem;
    color:#eaf0ff;
    margin:40px 0 20px;
    padding-bottom:10px;
    border-bottom:1px solid #2a3a61;
    display:flex;
    align-items:center;
    gap:10px;
  }
  
  .admin-empty-state{
    text-align:center;
    padding:60px 20px;
    color:#9daccc;
  }
  
  .admin-empty-state i{
    font-size:4rem;
    margin-bottom:20px;
    opacity:.5;
  }
  
  .admin-update-time{
    text-align:center;
    color:#9daccc;
    font-size:.9rem;
    margin-top:20px;
    padding:10px;
    background:#121a2a;
    border-radius:10px;
    border:1px solid #2a3a61;
  }
  
  /* Pulsante Admin speciale */
  .nav-link.admin-link{
    background:linear-gradient(45deg, #ff6b6b, #ffa500);
    color:#fff;
    border:1px solid #ffa500;
  }
  
  .nav-link.admin-link:hover{
    background:linear-gradient(45deg, #ff5252, #ff8c00);
    color:#fff;
  }

  /* Responsive */
  @media (max-width:600px){
    .title-roman{font-size:2rem; margin-bottom:22px}
    .discord-numbers{
      width:100%;
      justify-content:space-around;
    }
    .admin-users-grid{
      grid-template-columns:1fr;
    }
    .admin-stat-card{
      padding:18px;
    }
    .admin-header{
      flex-direction:column;
      align-items:stretch;
    }
  }
  </style>
</head>
<body>
  <noscript><div class="noscript">Attiva JavaScript per usare il sito.</div></noscript>

  <!-- NAVBAR -->
  <header class="site-header">
    <nav class="nav" id="mainNav">
      <a href="#" class="nav-link active" data-route="home">Home</a>
      <a href="#" class="nav-link" data-route="staff">Staff</a>
      <a href="#" class="nav-link" id="navDonations" data-route="donations" hidden>Donazioni</a>
      <a href="#" class="nav-link admin-link" id="navAdmin" data-route="admin" hidden>
        <i class="fa-solid fa-shield-halved"></i> Admin
      </a>
      <a href="#" class="nav-link" id="btnDiscordLogin" title="Login con Discord">
        Login <i class="fa-brands fa-discord" aria-hidden="true"></i>
      </a>
      <a href="#" class="nav-link" id="btnLogout" hidden>Logout</a>
    </nav>

    <div class="top-avatar" id="topAvatar" title="Utente">
      <i id="topAvatarIcon" class="fa-solid fa-circle-user"></i>
      <img id="topAvatarImg" alt="Avatar" crossorigin="anonymous">
      <span id="topUsername" hidden></span>
    </div>
  </header>

  <main id="app">
    <!-- HOME -->
    <section id="page-home" class="page active" data-page>
      <div class="hero">
        <div class="logo-container">
          <div class="logo-bg"></div>
          <div class="logo-glow"></div>
        </div>

        <div class="under-construction" aria-live="polite">
          <h1 class="uc-title">SITO IN COSTRUZIONE</h1>
        </div>

        <div class="home-video">
          <div class="home-video-head">
            <i class="fa-solid fa-film"></i>
            <span>Trailer server</span>
          </div>
          <div class="home-video-frame">
            <video id="nvVideo" src="https://files.catbox.moe/vq53u8.mp4" muted autoplay loop playsinline webkit-playsinline preload="auto"></video>
          </div>
        </div>

        <!-- ======= DISCORD: SOLO NUMERI (SEMPLICE) ======= -->
        <div class="discord-counts" id="discordCountsCard">
          <div class="discord-chip">
            <i class="fa-brands fa-discord"></i>
            <span id="guildName">Community Discord</span>
          </div>
          <div class="discord-numbers">
            <div class="discord-num">
              <span class="dc-label">Totali</span>
              <span class="dc-value" id="countTotal">—</span>
            </div>
            <div class="dc-divider"></div>
            <div class="discord-num">
              <span class="dc-label">Online</span>
              <span class="dc-value online" id="countOnline">—</span>
            </div>
          </div>
          <!-- tenuto solo per lo script, ma nascosto via CSS -->
          <span id="lastUpdate">Aggiornato</span>
        </div>
        <!-- ===================================== -->
      </div>
    </section>

    <!-- STAFF (come nel tuo file) -->
    <section id="page-staff" class="page" data-page>
      <h2 class="title-roman center">Il nostro staff</h2>

      <!-- Owner -->
      <div class="staff-section">
        <h3 class="role">
          <img class="role-icon" src="https://i.postimg.cc/G3WyHbDY/Chat-GPT-Image-17-giu-2025-14-39-09.png" alt="">Owner
        </h3>
        <div class="staff-grid">
          <div class="member">
            <div class="avatar ring ring-gold">
              <img src="https://i.postimg.cc/CxFBstcd/c37611adf5aecfcd368a2c30335adcd2.png" alt="Antonio" loading="lazy">
            </div>
            <div class="member-name">Antonio <i class="fa-solid fa-monkey"></i></div>
          </div>
        </div>
      </div>

      <!-- Founder -->
      <div class="staff-section">
        <h3 class="role">
          <img class="role-icon" src="https://i.postimg.cc/G3WyHbDY/Chat-GPT-Image-17-giu-2025-14-39-09.png" alt="">Founder
        </h3>
        <div class="staff-grid">
          <div class="member">
            <div class="avatar ring ring-silver">
              <img src="https://i.postimg.cc/PJWJmzZm/4352ec1303ecdc977d7d5742f735fff1.png" alt="Anto" loading="lazy">
            </div>
            <div class="member-name">Anto</div>
          </div>
          <div class="member">
            <div class="avatar ring ring-silver">
              <img src="https://i.postimg.cc/qqTMMhYg/e55c0b5b4bccca7cae37baa55d201851.png" alt="Mony" loading="lazy">
            </div>
            <div class="member-name">Mony</div>
          </div>
        </div>
      </div>

      <!-- Co-Founder -->
      <div class="staff-section">
        <h3 class="role">
          <img class="role-icon" src="https://i.postimg.cc/G3WyHbDY/Chat-GPT-Image-17-giu-2025-14-39-09.png" alt="">Co-Founder
        </h3>
        <div class="staff-grid">
          <div class="member">
            <div class="avatar ring">
              <img src="https://i.postimg.cc/PqvtWQnP/12b80f2e9ba912f14b31b5e266a0f682-1.png" alt="Gabbo" loading="lazy">
            </div>
            <div class="member-name">Gabbo</div>
            <div class="member-role role-dev">Developer</div>
          </div>
          <div class="member">
            <div class="avatar ring">
              <img src="https://i.postimg.cc/htkFBFNt/6ad827b1feba707e879d756b119a3686.png" alt="Rodriguez" loading="lazy">
            </div>
            <div class="member-name">Rodriguez</div>
            <div class="member-role role-dev">Developer</div>
          </div>
          <div class="member">
            <div class="avatar ring">
              <img src="https://i.postimg.cc/brNWTqS3/5f711a717fb7ba1b771d9945317115c4.png" alt="Th3b00ss" loading="lazy">
            </div>
            <div class="member-name">Th3b00ss</div>
          </div>
        </div>
      </div>

      <!-- Admin -->
      <div class="staff-section">
        <h3 class="role">
          <img class="role-icon" src="https://i.postimg.cc/7PfcnrLm/SOLO-DS.png" alt="">Admin
        </h3>
        <div class="staff-grid">
          <div class="member">
            <div class="avatar ring ring-red">
              <img src="https://i.postimg.cc/281X8cQb/1e61f8bb23ae0618379b441300fcfbd9.png" alt="Alexo" loading="lazy">
            </div>
            <div class="member-name">Alexo</div>
            <div class="member-role role-eup">Eup Creator</div>
          </div>
          <div class="member">
            <div class="avatar ring ring-red">
              <img src="https://i.postimg.cc/SKhZdmwC/a-e8e39e5c836119be3f60bcb65e14c6f4.png" alt="Chri" loading="lazy">
            </div>
            <div class="member-name">Chri</div>
            <div class="member-role role-dev">Developer</div>
          </div>
          <div class="member">
            <div class="avatar ring ring-red">
              <img src="https://i.postimg.cc/GtVKyRFB/0416d4b328c505304326a8dc8245cc17.png" alt="Il Davide" loading="lazy">
            </div>
            <div class="member-name">Il Davide</div>
            <div class="member-role role-eup">Eup Creator</div>
          </div>
        </div>
      </div>

      <!-- Moderatore -->
      <div class="staff-section">
        <h3 class="role">
          <img class="role-icon" src="https://i.postimg.cc/7PfcnrLm/SOLO-DS.png" alt="">Moderatore
        </h3>
        <div class="staff-grid">
          <div class="member">
            <div class="avatar ring ring-green">
              <img src="https://i.postimg.cc/43jpPPKM/b7bcf963d0aee00c3897fc99c712901b-1.png" alt="Ales" loading="lazy">
            </div>
            <div class="member-name">Ales</div>
            <div class="member-role role-dev">Developer</div>
          </div>
          <div class="member">
            <div class="avatar ring ring-green">
              <img src="https://i.postimg.cc/15ywvft9/1de106f2243b0a69cb7ad4cb3ad07fdd-1.png" alt="Blaze" loading="lazy">
            </div>
            <div class="member-name">Blaze</div>
            <div class="member-role role-grafico">Grafico</div>
          </div>
          <div class="member">
            <div class="avatar ring ring-green">
              <img src="https://i.postimg.cc/VNzPkJjH/a-edb3451e6d947e16ef4238d025acc7e2.png" alt="Franco" loading="lazy">
            </div>
            <div class="member-name">Franco</div>
            <div class="member-role role-grafico">Grafico</div>
          </div>
          <div class="member">
            <div class="avatar ring ring-green">
              <img src="https://i.postimg.cc/XqRTSqjL/10e50f9740ef0ec0128356b0e50bfa07.png" alt="Glaudio" loading="lazy">
            </div>
            <div class="member-name">Glaudio</div>
          </div>
          <div class="member">
            <div class="avatar ring ring-green">
              <img src="https://i.postimg.cc/K828tvPt/08d61d22900b74f0858eaa667928cc14.png" alt="Luca" loading="lazy">
            </div>
            <div class="member-name">Luca</div>
          </div>
          <div class="member">
            <div class="avatar ring ring-green">
              <img src="https://i.postimg.cc/nzCFnsxf/a-09025472357165cc6f701321fe17ac83-1.png" alt="Mattiger" loading="lazy">
            </div>
            <div class="member-name">Mattiger</div>
          </div>
          <div class="member">
            <div class="avatar ring ring-green">
              <img src="https://i.postimg.cc/TwFR1R2L/206addc7d0ca709d436ed6ee9536d6c6.png" alt="Voight" loading="lazy">
            </div>
            <div class="member-name">Voight</div>
          </div>
        </div>
      </div>

      <!-- Helper -->
      <div class="staff-section">
        <h3 class="role">
          <img class="role-icon" src="https://i.postimg.cc/7PfcnrLm/SOLO-DS.png" alt="">Helper
        </h3>
        <div class="staff-grid">
          <div class="member">
            <div class="avatar ring ring-purple">
              <img src="https://i.postimg.cc/Y2LrVm81/33bb0bad054c7588ba25fd7e14026687.png" alt="Andre" loading="lazy">
            </div>
            <div class="member-name">Andre</div>
          </div>
          <div class="member">
            <div class="avatar ring ring-purple">
              <img src="https://i.postimg.cc/P5TdPVH4/50c3a9ce68ae80848396cbdefe1f3280.png" alt="Falco" loading="lazy">
            </div>
            <div class="member-name">Falco</div>
          </div>
        </div>
      </div>
    </section>

    <!-- DONAZIONI (protetta) -->
    <section id="page-donations" class="page" data-page>
      <h2 class="title-roman">Sostieni Nova Roma</h2>
      <div id="donationsGrid" class="donations-grid">
        <a href="#" class="donation-card" data-price="5" data-img="https://i.postimg.cc/PxPsssLH/7-C030-F38-2503-4-D9-C-BE75-B89-FE9979-A30.png">
          <div class="donation-thumb"><img src="https://i.postimg.cc/PxPsssLH/7-C030-F38-2503-4-D9-C-BE75-B89-FE9979-A30.png" alt=""></div>
          <div class="donation-caption">Pacchetto 5€</div>
        </a>
        <a href="#" class="donation-card" data-price="10" data-img="https://i.postimg.cc/PxPsssLH/7-C030-F38-2503-4-D9-C-BE75-B89-FE9979-A30.png">
          <div class="donation-thumb"><img src="https://i.postimg.cc/PxPsssLH/7-C030-F38-2503-4-D9-C-BE75-B89-FE9979-A30.png" alt=""></div>
          <div class="donation-caption">Pacchetto 10€</div>
        </a>
        <a href="#" class="donation-card" data-price="15" data-img="https://i.postimg.cc/D0gS9hV6/F543-A4-DF-579-C-47-FD-B979-1-F09-DCF03-D8-A.png">
          <div class="donation-thumb"><img src="https://i.postimg.cc/D0gS9hV6/F543-A4-DF-579-C-47-FD-B979-1-F09-DCF03-D8-A.png" alt=""></div>
          <div class="donation-caption">Pacchetto 15€</div>
        </a>
        <a href="#" class="donation-card" data-price="20" data-img="https://i.postimg.cc/D0gS9hV6/F543-A4-DF-579-C-47-FD-B979-1-F09-DCF03-D8-A.png">
          <div class="donation-thumb"><img src="https://i.postimg.cc/D0gS9hV6/F543-A4-DF-579-C-47-FD-B979-1-F09-DCF03-D8-A.png" alt=""></div>
          <div class="donation-caption">Pacchetto 20€</div>
        </a>
        <a href="#" class="donation-card" data-price="30" data-img="https://i.postimg.cc/gjDpzk2w/D837-B10-D-40-F9-488-B-B4-EB-B217-A5-FB4-C8-B.png">
          <div class="donation-thumb"><img src="https://i.postimg.cc/gjDpzk2w/D837-B10-D-40-F9-488-B-B4-EB-B217-A5-FB4-C8-B.png" alt=""></div>
          <div class="donation-caption">Pacchetto 30€</div>
        </a>
        <a href="#" class="donation-card" data-price="40" data-img="https://i.postimg.cc/gjDpzk2w/D837-B10-D-40-F9-488-B-B4-EB-B217-A5-FB4-C8-B.png">
          <div class="donation-thumb"><img src="https://i.postimg.cc/gjDpzk2w/D837-B10-D-40-F9-488-B-B4-EB-B217-A5-FB4-C8-B.png" alt=""></div>
          <div class="donation-caption">Pacchetto 40€</div>
        </a>
        <a href="#" class="donation-card" data-price="50" data-img="https://i.postimg.cc/wx1HnJJN/44-BD2-E33-65-AB-44-DD-89-C9-2-EAFCEE9917-B.png">
          <div class="donation-thumb"><img src="https://i.postimg.cc/wx1HnJJN/44-BD2-E33-65-AB-44-DD-89-C9-2-EAFCEE9917-B.png" alt=""></div>
          <div class="donation-caption">Pacchetto 50€</div>
        </a>
        <a href="#" class="donation-card" data-price="70" data-img="https://i.postimg.cc/wx1HnJJN/44-BD2-E33-65-AB-44-DD-89-C9-2-EAFCEE9917-B.png">
          <div class="donation-thumb"><img src="https://i.postimg.cc/wx1HnJJN/44-BD2-E33-65-AB-44-DD-89-C9-2-EAFCEE9917-B.png" alt=""></div>
          <div class="donation-caption">Pacchetto 70€</div>
        </a>
      </div>
    </section>

    <!-- DONAZIONE DETTAGLIO (protetta) -->
    <section id="page-donation" class="page" data-page>
      <div class="card">
        <header style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
          <div class="chip"><i class="fa-solid fa-gift"></i></div>
          <div>
            <h3 class="title-roman" id="detailTitle">Pacchetto</h3>
            <p style="color:#9daccc;font-size:.9rem">Riepilogo offerta</p>
          </div>
        </header>
        <div class="donation-detail">
          <div class="donation-media"><img id="detailImg" alt="Pacchetto"></div>
          <div class="donation-info">
            <div class="price"><span id="detailPrice">0</span>€</div>
            <pre id="detailDesc"></pre>
            <div class="actions" style="justify-content:flex-start">
              <button class="btn btn-primary" id="btnBuy"><i class="fa-solid fa-credit-card"></i> Procedi</button>
              <button class="btn btn-ghost" id="btnBackDon"><i class="fa-solid fa-arrow-left"></i> Torna alle donazioni</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGINA ADMIN (visibile solo all'utente specifico) -->
    <section id="page-admin" class="page" data-page>
      <div class="admin-container">
        <div class="admin-header">
          <h2 class="title-roman">Pannello Amministratore LIVE</h2>
          <div style="display:flex;align-items:center;gap:15px;">
            <div class="admin-live-badge">
              <i class="fa-solid fa-circle" style="font-size:.6rem"></i>
              LIVE
            </div>
            <button id="adminRefreshBtn" class="admin-refresh-btn">
              <i class="fa-solid fa-rotate"></i>
              Aggiorna
            </button>
          </div>
        </div>
        
        <div class="admin-stats-grid">
          <div class="admin-stat-card">
            <i class="fa-solid fa-users" style="font-size:2rem;color:#58a6ff"></i>
            <div class="admin-stat-value" id="adminTotalUsers">0</div>
            <div class="admin-stat-label">Utenti Totali</div>
            <div class="admin-stat-sub" id="adminTotalSub">Aggiornato: <span id="adminTotalTime">—</span></div>
          </div>
          
          <div class="admin-stat-card">
            <i class="fa-solid fa-user-clock" style="font-size:2rem;color:#7ee787"></i>
            <div class="admin-stat-value" id="adminActiveUsers">0</div>
            <div class="admin-stat-label">Utenti Attivi (24h)</div>
            <div class="admin-stat-sub" id="adminActiveSub">Aggiornato: <span id="adminActiveTime">—</span></div>
          </div>
          
          <div class="admin-stat-card">
            <i class="fa-solid fa-user-check" style="font-size:2rem;color:#ffa500"></i>
            <div class="admin-stat-value" id="adminOnlineNow">0</div>
            <div class="admin-stat-label">Online Ora</div>
            <div class="admin-stat-sub" id="adminOnlineSub">Aggiornato: <span id="adminOnlineTime">—</span></div>
          </div>
          
          <div class="admin-stat-card">
            <i class="fa-solid fa-clock" style="font-size:2rem;color:#a78bfa"></i>
            <div class="admin-stat-value" id="adminAvgTime">0m</div>
            <div class="admin-stat-label">Tempo Medio Sessione</div>
            <div class="admin-stat-sub" id="adminAvgSub">Aggiornato: <span id="adminAvgTimeTime">—</span></div>
          </div>
        </div>
        
        <h3 class="admin-section-title">
          <i class="fa-solid fa-users-viewfinder"></i>
          Utenti Collegati Recentemente
          <span style="font-size:1rem;color:#9daccc;margin-left:auto;" id="adminUsersCount">(0 utenti)</span>
        </h3>
        
        <div id="adminUsersList" class="admin-users-grid">
          <!-- Gli utenti verranno caricati qui dinamicamente -->
        </div>
        
        <div id="adminNoUsers" class="admin-empty-state" style="display:none;">
          <i class="fa-solid fa-user-slash"></i>
          <p>Nessun utente ha ancora effettuato il login.</p>
          <p style="font-size:.9rem;margin-top:10px;">Gli utenti appariranno qui dopo aver effettuato il login.</p>
        </div>
        
        <div class="admin-update-time">
          <i class="fa-solid fa-clock-rotate-left"></i>
          Ultimo aggiornamento completo: <span id="adminFullUpdateTime">—</span>
          • Prossimo aggiornamento automatico tra: <span id="adminNextUpdate">—</span>
        </div>
        
        <div style="margin-top:40px;padding:20px;background:#121a2a;border-radius:14px;border:1px solid #2a3a61;">
          <h3 style="color:#eaf0ff;margin-bottom:15px;font-size:1.4rem;">
            <i class="fa-solid fa-info-circle" style="color:#58a6ff;margin-right:8px;"></i>
            Informazioni Sistema LIVE
          </h3>
          <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:15px;">
            <div>
              <div style="color:#9daccc;font-size:.9rem;">ID Admin Autorizzato</div>
              <div style="color:#eaf0ff;font-family:monospace;font-size:1.1rem;">640478852308664360</div>
            </div>
            <div>
              <div style="color:#9daccc;font-size:.9rem;">Stato Aggiornamento</div>
              <div style="color:#eaf0ff;font-size:1.1rem;display:flex;align-items:center;gap:8px;">
                <span id="adminUpdateStatus">Attivo</span>
                <i class="fa-solid fa-circle" style="color:#7ee787;font-size:.7rem;"></i>
              </div>
            </div>
            <div>
              <div style="color:#9daccc;font-size:.9rem;">Frequenza Aggiornamento</div>
              <div style="color:#eaf0ff;font-size:1.1rem;">3 secondi</div>
            </div>
            <div>
              <div style="color:#9daccc;font-size:.9rem;">Sistema Tracciamento</div>
              <div style="color:#eaf0ff;font-size:1.1rem;" id="adminSystemStatus">WebSocket Attivo</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="stripe"></div>
    <p>© 2025 Nova Roma Roleplay</p>
    <div class="footer-icons" aria-label="Social">
      <a class="ig" href="https://www.instagram.com/novaromaroleplay?igsh=ZngzZGZqNHM1Mmky" target="_blank" rel="noopener" aria-label="Instagram">
        <i class="fa-brands fa-instagram" aria-hidden="true"></i>
      </a>
      <a class="yt" href="https://youtube.com/@novaromarp?si=A5FuufVL9c9LEBAc" target="_blank" rel="noopener" aria-label="YouTube">
        <i class="fa-brands fa-youtube" aria-hidden="true"></i>
      </a>
      <a class="tt" href="https://www.tiktok.com/@novaromarp?_t=ZN-8xEfyEObCFi&_r=1" target="_blank" rel="noopener" aria-label="TikTok">
        <i class="fa-brands fa-tiktok" aria-hidden="true"></i>
      </a>
      <a class="dc" href="https://discord.gg/EubyJqDGwU" target="_blank" rel="noopener" aria-label="Discord">
        <i class="fa-brands fa-discord" aria-hidden="true"></i>
      </a>
    </div>
  </footer>

  <div class="loader" id="loginLoader">Login in corso…</div>

  <script>
  /* ===== CONFIG ===== */
  const DISCORD_CLIENT_ID = '1419444744563720404';
  const DISCORD_SCOPE = 'identify';
  const REDIRECT_URI = 'https://alestv05.github.io/sito/';
  const DISCORD_INVITE_URL = 'https://discord.gg/EubyJqDGwU';
  const INVITE_CODE = DISCORD_INVITE_URL.split('/').filter(Boolean).pop();
  
  // ID dell'admin autorizzato (TUO ID DISCORD)
  const ADMIN_USER_ID = '640478852308664360';
  
  // Configurazione aggiornamenti LIVE
  const ADMIN_UPDATE_INTERVAL = 3000; // 3 secondi per aggiornamenti rapidi
  const USER_HEARTBEAT_INTERVAL = 10000; // 10 secondi per heartbeat
  const USER_ONLINE_THRESHOLD = 300000; // 5 minuti considerati online
  const USER_ACTIVE_THRESHOLD = 60000; // 1 minuto considerati attivi

  /* Storage keys - VERSIONI UNICHE PER OGNI BROWSER/TAB */
  const TAB_ID = 'tab_' + Math.random().toString(36).substr(2, 9);
  const SESSION_ID = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  
  const OAUTH_TOKEN_KEY = 'nr_discord_token_v2';
  const OAUTH_USER_KEY  = 'nr_discord_user_v2';
  const OAUTH_EXP_KEY   = 'nr_discord_expires_at_v2';
  
  /* Storage condiviso tra tutte le schede */
  const SHARED_USERS_KEY = 'nr_shared_users_v2';
  const SHARED_ACTIVITY_KEY = 'nr_shared_activity_v2';
  const SHARED_SESSIONS_KEY = 'nr_shared_sessions_v2';

  /* Utils */
  const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
  const delay=ms=>new Promise(r=>setTimeout(r,ms));
  const toast=t=>{const x=$('.toast');if(x)x.remove();const el=document.createElement('div');el.className='toast';el.textContent=t;document.body.appendChild(el);setTimeout(()=>el.classList.add('show'),10);setTimeout(()=>{el.classList.remove('show');setTimeout(()=>el.remove(),300);},3000);};
  const showLoader=(on)=>{$('#loginLoader')?.classList.toggle('show',!!on);};
  const originOf = url => new URL(url, location.href).origin;
  const cdnDefaultAvatar = (i=0)=>`https://cdn.discordapp.com/embed/avatars/${(Number(i)%5)||0}.png`;
  const nowMs = ()=>Date.now();
  const generateId = ()=>Date.now() + '_' + Math.random().toString(36).substr(2, 9);

  const protectedRoutes = new Set(['donations','donation']);
  const adminRoutes = new Set(['admin']);

  /* Variabili globali per gestione LIVE */
  let adminUpdateInterval = null;
  let userHeartbeatInterval = null;
  let isUpdatingAdminPanel = false;
  let lastFullUpdateTime = nowMs();
  let currentUserData = null;

  /* ===== SISTEMA DI TRACCIAMENTO CONDIVISO ===== */
  
  // Inizializza storage condiviso
  function initSharedStorage(){
    try{
      // Inizializza solo se non esiste
      if(!localStorage.getItem(SHARED_USERS_KEY)){
        localStorage.setItem(SHARED_USERS_KEY, JSON.stringify([]));
      }
      if(!localStorage.getItem(SHARED_ACTIVITY_KEY)){
        localStorage.setItem(SHARED_ACTIVITY_KEY, JSON.stringify({}));
      }
      if(!localStorage.getItem(SHARED_SESSIONS_KEY)){
        localStorage.setItem(SHARED_SESSIONS_KEY, JSON.stringify({}));
      }
    }catch(e){
      console.error('Errore inizializzazione storage:', e);
    }
  }
  
  // Ottieni tutti gli utenti registrati
  function getSharedUsers(){
    try{
      const data = localStorage.getItem(SHARED_USERS_KEY);
      return data ? JSON.parse(data) : [];
    }catch(e){
      return [];
    }
  }
  
  // Salva tutti gli utenti
  function saveSharedUsers(users){
    try{
      localStorage.setItem(SHARED_USERS_KEY, JSON.stringify(users));
    }catch(e){
      console.error('Errore salvataggio utenti condivisi:', e);
    }
  }
  
  // Ottieni attività corrente
  function getSharedActivity(){
    try{
      const data = localStorage.getItem(SHARED_ACTIVITY_KEY);
      return data ? JSON.parse(data) : {};
    }catch(e){
      return {};
    }
  }
  
  // Salva attività corrente
  function saveSharedActivity(activity){
    try{
      localStorage.setItem(SHARED_ACTIVITY_KEY, JSON.stringify(activity));
    }catch(e){
      console.error('Errore salvataggio attività condivisa:', e);
    }
  }
  
  // Ottieni sessioni
  function getSharedSessions(){
    try{
      const data = localStorage.getItem(SHARED_SESSIONS_KEY);
      return data ? JSON.parse(data) : {};
    }catch(e){
      return {};
    }
  }
  
  // Salva sessioni
  function saveSharedSessions(sessions){
    try{
      localStorage.setItem(SHARED_SESSIONS_KEY, JSON.stringify(sessions));
    }catch(e){
      console.error('Errore salvataggio sessioni condivise:', e);
    }
  }
  
  // Registra un nuovo utente o aggiorna uno esistente
  function registerSharedUser(user){
    if(!user || !user.id) return null;
    
    const users = getSharedUsers();
    const now = nowMs();
    
    // Cerca utente esistente
    const existingUserIndex = users.findIndex(u => u.id === user.id);
    
    const userData = {
      id: user.id,
      username: user.username || '',
      global_name: user.global_name || user.username || '',
      avatar: user.avatar || null,
      discriminator: user.discriminator || '0',
      firstSeen: existingUserIndex >= 0 ? users[existingUserIndex].firstSeen : now,
      lastSeen: now,
      loginCount: existingUserIndex >= 0 ? users[existingUserIndex].loginCount + 1 : 1,
      tabId: TAB_ID,
      sessionId: SESSION_ID
    };
    
    if(existingUserIndex >= 0){
      users[existingUserIndex] = userData;
    }else{
      users.push(userData);
    }
    
    saveSharedUsers(users);
    return userData;
  }
  
  // Aggiorna attività utente
  function updateSharedActivity(userId){
    if(!userId) return;
    
    const now = nowMs();
    const activity = getSharedActivity();
    
    if(!activity[userId]){
      activity[userId] = {};
    }
    
    activity[userId][TAB_ID] = {
      lastActive: now,
      sessionId: SESSION_ID,
      tabId: TAB_ID,
      userAgent: navigator.userAgent,
      timestamp: now
    };
    
    saveSharedActivity(activity);
    
    // Aggiorna anche lastSeen nella lista utenti
    const users = getSharedUsers();
    const userIndex = users.findIndex(u => u.id === userId);
    if(userIndex >= 0){
      users[userIndex].lastSeen = now;
      users[userIndex].tabId = TAB_ID;
      saveSharedUsers(users);
    }
  }
  
  // Registra una nuova sessione
  function registerSharedSession(userId, userData){
    if(!userId || !userData) return;
    
    const sessions = getSharedSessions();
    const now = nowMs();
    
    if(!sessions[userId]){
      sessions[userId] = [];
    }
    
    // Aggiungi nuova sessione
    sessions[userId].push({
      sessionId: SESSION_ID,
      tabId: TAB_ID,
      start: now,
      end: null,
      userData: {
        username: userData.username,
        global_name: userData.global_name,
        avatar: userData.avatar
      }
    });
    
    // Mantieni solo le ultime 50 sessioni per utente
    if(sessions[userId].length > 50){
      sessions[userId] = sessions[userId].slice(-50);
    }
    
    saveSharedSessions(sessions);
  }
  
  // Termina sessione
  function endSharedSession(userId){
    if(!userId) return;
    
    const sessions = getSharedSessions();
    if(sessions[userId]){
      const userSessions = sessions[userId];
      const activeSession = userSessions.find(s => s.sessionId === SESSION_ID && !s.end);
      
      if(activeSession){
        activeSession.end = nowMs();
        saveSharedSessions(sessions);
      }
    }
    
    // Rimuovi attività per questa tab
    const activity = getSharedActivity();
    if(activity[userId] && activity[userId][TAB_ID]){
      delete activity[userId][TAB_ID];
      
      // Se non ci sono più tab attive per questo utente, rimuovi completamente
      if(Object.keys(activity[userId]).length === 0){
        delete activity[userId];
      }
      
      saveSharedActivity(activity);
    }
  }
  
  // Pulisci attività vecchie
  function cleanupOldActivity(){
    const now = nowMs();
    const activity = getSharedActivity();
    let changed = false;
    
    // Pulisci attività più vecchie di 1 minuto
    for(const userId in activity){
      for(const tabId in activity[userId]){
        if(now - activity[userId][tabId].lastActive > 60000){ // 1 minuto
          delete activity[userId][tabId];
          changed = true;
        }
      }
      
      // Se l'utente non ha più attività, rimuovilo
      if(Object.keys(activity[userId]).length === 0){
        delete activity[userId];
        changed = true;
      }
    }
    
    if(changed){
      saveSharedActivity(activity);
    }
    
    // Pulisci sessioni vecchie (più di 24 ore)
    const sessions = getSharedSessions();
    for(const userId in sessions){
      sessions[userId] = sessions[userId].filter(session => 
        !session.end || (now - session.end) < (24 * 60 * 60 * 1000)
      );
      
      if(sessions[userId].length === 0){
        delete sessions[userId];
      }
    }
    
    saveSharedSessions(sessions);
  }
  
  // Ottieni statistiche aggiornate
  function getAdminStats(){
    const users = getSharedUsers();
    const activity = getSharedActivity();
    const now = nowMs();
    
    // Utenti totali unici
    const totalUsers = users.length;
    
    // Utenti attivi nelle ultime 24 ore
    const active24h = users.filter(user => 
      (now - user.lastSeen) < (24 * 60 * 60 * 1000)
    ).length;
    
    // Utenti online ora (attività negli ultimi 5 minuti)
    let onlineNow = 0;
    const onlineUsers = [];
    
    for(const userId in activity){
      const userActivities = Object.values(activity[userId]);
      const mostRecent = Math.max(...userActivities.map(a => a.lastActive));
      
      if(now - mostRecent < USER_ONLINE_THRESHOLD){
        onlineNow++;
        onlineUsers.push(userId);
      }
    }
    
    // Calcola tempo medio sessione
    const sessions = getSharedSessions();
    let totalSessionTime = 0;
    let totalSessions = 0;
    
    for(const userId in sessions){
      sessions[userId].forEach(session => {
        if(session.start && session.end){
          totalSessionTime += (session.end - session.start);
          totalSessions++;
        }else if(session.start && !session.end){
          // Sessione ancora attiva
          totalSessionTime += (now - session.start);
          totalSessions++;
        }
      });
    }
    
    const avgSessionTime = totalSessions > 0 ? 
      Math.round(totalSessionTime / totalSessions / 60000) : 0;
    
    return {
      totalUsers,
      active24h,
      onlineNow,
      onlineUsers,
      avgSessionTime,
      totalSessions
    };
  }

  /* ===== LOGIN CON AVATAR ===== */
  const getToken = ()=>{
    const token = localStorage.getItem(OAUTH_TOKEN_KEY);
    const exp = Number(localStorage.getItem(OAUTH_EXP_KEY)||0);
    if(!token || !exp) return null;
    if(nowMs() >= exp){ clearSession(); return null; }
    return token;
  };
  
  const isLoggedIn = ()=>!!(getToken() && localStorage.getItem(OAUTH_USER_KEY));
  
  function clearSession(){
    const user = JSON.parse(localStorage.getItem(OAUTH_USER_KEY)||'null');
    if(user && user.id){
      endSharedSession(user.id);
    }
    
    localStorage.removeItem(OAUTH_TOKEN_KEY);
    localStorage.removeItem(OAUTH_USER_KEY);
    localStorage.removeItem(OAUTH_EXP_KEY);
    sessionStorage.removeItem('oauth_state');
    currentUserData = null;
  }
  
  function formatDiscordName(user){
    if(!user) return '';
    const disc = user.discriminator && user.discriminator !== '0' ? `#${user.discriminator}` : '';
    return (user.global_name || user.username || 'Utente') + disc;
  }
  
  function getAvatarUrl(user){
    if(!user) return null;
    
    if(user.avatar && user.id){
      const format = user.avatar.startsWith('a_') ? 'gif' : 'png';
      return `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.${format}?size=128`;
    }
    
    const discriminator = parseInt(user.discriminator || '0', 10);
    return cdnDefaultAvatar(discriminator);
  }
  
  function setAvatar(url){
    const topImg=$('#topAvatarImg');
    const topIcon=$('#topAvatarIcon');
    
    if(url){
      const img = new Image();
      img.src = url;
      img.onload = () => {
        topImg.src = url;
        topImg.style.display = 'block';
        topIcon.style.display = 'none';
      };
      img.onerror = () => {
        topImg.src = cdnDefaultAvatar();
        topImg.style.display = 'block';
        topIcon.style.display = 'none';
      };
    } else {
      topImg.removeAttribute('src');
      topImg.style.display = 'none';
      topIcon.style.display = 'block';
    }
  }
  
  function setUserHeader(user){
    if(!user){
      setAvatar(null);
      $('#topUsername').textContent = '';
      $('#topUsername').hidden = true;
      $('#topAvatar').title = 'Utente';
      return;
    }
    
    const avatarUrl = getAvatarUrl(user);
    setAvatar(avatarUrl);
    
    const name = formatDiscordName(user);
    const el = $('#topUsername');
    if(name){
      el.textContent = name;
      el.hidden = false;
      $('#topAvatar').title = name;
    } else {
      el.textContent = '';
      el.hidden = true;
      $('#topAvatar').title = 'Utente';
    }
  }
  
  function isAdminUser(){
    const user = JSON.parse(localStorage.getItem(OAUTH_USER_KEY)||'null');
    return user && user.id === ADMIN_USER_ID;
  }
  
  function updateAuthUI(){
    const token = getToken();
    const user  = JSON.parse(localStorage.getItem(OAUTH_USER_KEY)||'null');
    const isIn = !!(token && user);
    const isAdmin = isAdminUser();
    
    $('#navDonations').hidden = !isIn;
    $('#navAdmin').hidden = !isAdmin;
    $('#btnDiscordLogin').hidden = isIn;
    $('#btnLogout').hidden = !isIn;
    
    if(isIn){
      setUserHeader(user);
      currentUserData = user;
      
      // Aggiorna attività utente
      updateSharedActivity(user.id);
      
      if(isAdmin){
        startAdminUpdates();
        if($('.page.active')?.id === 'page-admin'){
          updateAdminPanel();
        }
      }
    } else {
      setAvatar(null);
      const n = $('#topUsername');
      n.textContent = '';
      n.hidden = true;
      $('#topAvatar').title = 'Utente';
      currentUserData = null;
      
      if(isAdmin){
        stopAdminUpdates();
      }
      
      const active = document.querySelector('.page.active')?.id?.replace('page-','');
      if(protectedRoutes.has(active) || (adminRoutes.has(active) && !isAdmin)){
        showPage('home');
        if(adminRoutes.has(active)){
          toast('Accesso riservato all\'amministratore.');
        }else{
          toast('Effettua il login per accedere a questa sezione.');
        }
      }
    }
  }
  
  function buildAuthURL(state){
    const u = new URL('https://discord.com/oauth2/authorize');
    u.searchParams.set('client_id', DISCORD_CLIENT_ID);
    u.searchParams.set('redirect_uri', REDIRECT_URI);
    u.searchParams.set('response_type', 'token');
    u.searchParams.set('scope', DISCORD_SCOPE);
    u.searchParams.set('state', state);
    return u.toString();
  }
  
  function beginDiscordLogin(e){
    if(e){ e.preventDefault(); e.stopPropagation(); }
    
    if(isLoggedIn()){
      toast('Sei già loggato!');
      return;
    }
    
    const state = Math.random().toString(36).slice(2);
    sessionStorage.setItem('oauth_state', state);
    const url = buildAuthURL(state);
    
    const w = 520, h = 700;
    const y = window.top.outerHeight/2 + window.top.screenY - (h/2);
    const x = window.top.outerWidth/2 + window.top.screenX - (w/2);
    
    const popup = window.open(
      url,
      'discord_oauth',
      `width=${w},height=${h},left=${x},top=${y},resizable=yes,scrollbars=yes`
    );
    
    showLoader(true);
    $('#btnDiscordLogin').classList.add('disabled');
    
    if(!popup || popup.closed || typeof popup.closed === 'undefined'){
      window.location.assign(url);
      return;
    }
    
    const onMsg = async (ev) => {
      if(ev.origin !== originOf(REDIRECT_URI)) return;
      const data = ev.data || {};
      if(data.type !== 'discord_oauth') return;
      
      window.removeEventListener('message', onMsg);
      try{
        await finalizeOAuth({
          access_token: data.access_token,
          token_type: data.token_type || 'Bearer',
          expires_in: data.expires_in || 3600
        });
        popup && popup.close();
      } finally {
        showLoader(false);
        $('#btnDiscordLogin').classList.remove('disabled');
      }
    };
    
    window.addEventListener('message', onMsg);
    
    const timer = setInterval(() => {
      if(popup.closed){
        clearInterval(timer);
        window.removeEventListener('message', onMsg);
        showLoader(false);
        $('#btnDiscordLogin').classList.remove('disabled');
      }
    }, 500);
  }
  
  async function handleOAuthRedirectFragment(){
    if(!location.hash.startsWith('#')) return false;
    
    const params = new URLSearchParams(location.hash.slice(1));
    if(!(params.get('access_token') || params.get('error'))) return false;
    
    history.replaceState(null, '', location.pathname + location.search);
    
    if(window.opener && typeof window.opener.postMessage === 'function'){
      const payload = {
        type: 'discord_oauth',
        access_token: params.get('access_token'),
        token_type: params.get('token_type') || 'Bearer',
        expires_in: Number(params.get('expires_in') || 3600),
        state: params.get('state')
      };
      
      const targetOrigin = window.opener.location ? window.opener.location.origin : '*';
      window.opener.postMessage(payload, targetOrigin);
      
      document.body.innerHTML = '<div style="padding:20px;font:600 16px sans-serif;color:#eaf0ff;background:#0f1625;height:100vh;display:grid;place-items:center">Autenticazione completata, puoi chiudere questa finestra…</div>';
      setTimeout(() => window.close(), 250);
      return true;
    }
    
    if(params.get('error')){
      toast('Accesso Discord annullato.');
      return true;
    }
    
    const at = params.get('access_token');
    const tokenType = params.get('token_type') || 'Bearer';
    const expiresIn = Number(params.get('expires_in') || 3600);
    const state = params.get('state');
    const expected = sessionStorage.getItem('oauth_state');
    
    sessionStorage.removeItem('oauth_state');
    
    if(!at || (expected && expected !== state)){
      toast('Verifica OAuth fallita.');
      return true;
    }
    
    showLoader(true);
    try{
      await finalizeOAuth({
        access_token: at,
        token_type: tokenType,
        expires_in: expiresIn
      });
    } catch(_){
      toast('Errore nel recupero del profilo Discord.');
    } finally{
      showLoader(false);
    }
    
    return true;
  }
  
  async function finalizeOAuth({access_token, token_type = 'Bearer', expires_in = 3600}){
    if(!access_token) throw new Error('Token mancante');
    
    const expiresAt = nowMs() + (Number(expires_in) || 3600) * 1000 - 30000;
    
    localStorage.setItem(OAUTH_TOKEN_KEY, access_token);
    localStorage.setItem(OAUTH_EXP_KEY, String(expiresAt));
    
    const user = await fetchWithTimeoutRetry(
      'https://discord.com/api/users/@me',
      {
        headers: {
          'Authorization': `${token_type} ${access_token}`
        }
      },
      6000,
      1
    );
    
    localStorage.setItem(OAUTH_USER_KEY, JSON.stringify(user));
    
    // Registra utente nel sistema condiviso
    const registeredUser = registerSharedUser(user);
    if(registeredUser){
      registerSharedSession(user.id, registeredUser);
      updateSharedActivity(user.id);
    }
    
    updateAuthUI();
    toast(`Benvenuto ${formatDiscordName(user)}!`);
    
    // Avvia heartbeat per questo utente
    startUserHeartbeat();
  }
  
  async function fetchWithTimeoutRetry(url, options={}, timeoutMs=6000, retries=1){
    for(let attempt=0; attempt <= retries; attempt++){
      const ctrl = new AbortController();
      const timeout = setTimeout(() => ctrl.abort(), timeoutMs);
      
      try{
        const res = await fetch(url, {...options, signal: ctrl.signal});
        clearTimeout(timeout);
        
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch(err){
        clearTimeout(timeout);
        if(attempt === retries) throw err;
        await delay(300);
      }
    }
  }
  
  let expTimer = null;
  function scheduleAutoLogout(){
    if(expTimer) clearTimeout(expTimer);
    
    const exp = Number(localStorage.getItem(OAUTH_EXP_KEY) || 0);
    if(!exp) return;
    
    const wait = Math.max(0, exp - nowMs());
    expTimer = setTimeout(() => {
      logout();
      toast('Sessione scaduta, effettua di nuovo il login.');
    }, wait);
  }
  
  function logout(e){
    if(e){
      e.preventDefault();
      e.stopPropagation();
    }
    
    const user = JSON.parse(localStorage.getItem(OAUTH_USER_KEY) || 'null');
    const name = user ? formatDiscordName(user) : '';
    
    clearSession();
    if(location.hash){
      history.replaceState(null, '', location.pathname + location.search);
    }
    
    updateAuthUI();
    showPage('home');
    toast(name ? `Arrivederci ${name}!` : 'Logout effettuato');
  }

  /* ===== PANNELO ADMIN LIVE ===== */
  function formatTimeAgo(timestamp){
    const now = nowMs();
    const diff = now - timestamp;
    
    if(diff < 1000){
      return 'Adesso';
    }else if(diff < 60000){
      const secs = Math.floor(diff / 1000);
      return `${secs} sec fa`;
    }else if(diff < 3600000){
      const mins = Math.floor(diff / 60000);
      return `${mins} min fa`;
    }else if(diff < 86400000){
      const hours = Math.floor(diff / 3600000);
      return `${hours} ore fa`;
    }else{
      const days = Math.floor(diff / 86400000);
      return `${days} giorni fa`;
    }
  }
  
  function formatDate(timestamp){
    const date = new Date(timestamp);
    return date.toLocaleTimeString('it-IT', {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
  }
  
  function formatTimeUntil(timestamp){
    const now = nowMs();
    const diff = timestamp - now;
    
    if(diff <= 0) return 'Adesso';
    
    const seconds = Math.floor(diff / 1000);
    return `${seconds}s`;
  }
  
  async function updateAdminPanel(){
    if(!isAdminUser()) return;
    if(isUpdatingAdminPanel) return;
    
    isUpdatingAdminPanel = true;
    const btn = $('#adminRefreshBtn');
    if(btn) btn.classList.add('refreshing');
    
    try{
      cleanupOldActivity();
      const stats = getAdminStats();
      const users = getSharedUsers();
      const activity = getSharedActivity();
      const now = nowMs();
      
      lastFullUpdateTime = now;
      
      // Aggiorna statistiche
      $('#adminTotalUsers').textContent = stats.totalUsers;
      $('#adminActiveUsers').textContent = stats.active24h;
      $('#adminOnlineNow').textContent = stats.onlineNow;
      $('#adminAvgTime').textContent = `${stats.avgSessionTime}m`;
      
      // Aggiorna timestamp
      $('#adminTotalTime').textContent = formatDate(now);
      $('#adminActiveTime').textContent = formatDate(now);
      $('#adminOnlineTime').textContent = formatDate(now);
      $('#adminAvgTimeTime').textContent = formatDate(now);
      
      // Aggiorna lista utenti
      const usersList = $('#adminUsersList');
      const noUsers = $('#adminNoUsers');
      
      if(users.length === 0){
        usersList.innerHTML = '';
        noUsers.style.display = 'block';
        usersList.style.display = 'none';
        $('#adminUsersCount').textContent = '(0 utenti)';
      }else{
        noUsers.style.display = 'none';
        usersList.style.display = 'grid';
        $('#adminUsersCount').textContent = `(${users.length} utenti)`;
        
        // Ordina utenti per ultimo accesso
        const sortedUsers = [...users].sort((a, b) => b.lastSeen - a.lastSeen);
        
        usersList.innerHTML = sortedUsers.map(user => {
          const userActivity = activity[user.id] ? Object.values(activity[user.id]) : [];
          const mostRecentActivity = userActivity.length > 0 ? 
            Math.max(...userActivity.map(a => a.lastActive)) : 0;
          
          const isOnline = mostRecentActivity && 
            (now - mostRecentActivity) < USER_ONLINE_THRESHOLD;
          
          const isActiveNow = mostRecentActivity && 
            (now - mostRecentActivity) < USER_ACTIVE_THRESHOLD;
          
          const activeTabs = userActivity.length;
          
          const avatarUrl = user.avatar ? 
            `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.${user.avatar.startsWith('a_')?'gif':'png'}?size=80` :
            cdnDefaultAvatar(user.discriminator);
          
          const username = user.global_name || user.username || 'Sconosciuto';
          const discriminator = user.discriminator && user.discriminator !== '0' ? `#${user.discriminator}` : '';
          const fullName = username + discriminator;
          
          const lastSeenText = isOnline ? 
            (isActiveNow ? 
              `ATTIVO ORA (${activeTabs} tab)` : 
              `Online ${formatTimeAgo(mostRecentActivity)} (${activeTabs} tab)`) : 
            `Offline ${formatTimeAgo(user.lastSeen)}`;
          
          return `
            <div class="admin-user-card">
              ${isActiveNow ? '<div class="admin-user-pulse"></div>' : ''}
              <img src="${avatarUrl}" alt="${username}" class="admin-user-avatar" crossorigin="anonymous">
              <div class="admin-user-info">
                <div class="admin-user-name">${fullName}</div>
                <div class="admin-user-id">ID: ${user.id}</div>
                <div class="admin-user-status ${isOnline ? 'status-online' : 'status-offline'}">
                  ${isOnline ? 'ONLINE' : 'OFFLINE'} ${activeTabs > 1 ? `(${activeTabs})` : ''}
                </div>
                <div class="admin-user-last-seen">
                  ${lastSeenText}<br>
                  Login: ${user.loginCount || 1} • Prima volta: ${formatTimeAgo(user.firstSeen)}
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      // Aggiorna informazioni sistema
      $('#adminFullUpdateTime').textContent = `${formatDate(now)} (${formatTimeAgo(now)})`;
      $('#adminNextUpdate').textContent = formatTimeUntil(now + ADMIN_UPDATE_INTERVAL);
      $('#adminUpdateStatus').textContent = `Aggiornato`;
      
      // Aggiorna stato sistema
      $('#adminSystemStatus').textContent = `Attivo (${stats.onlineNow} online)`;
      
    }catch(error){
      console.error('Errore aggiornamento pannello admin:', error);
      $('#adminUpdateStatus').textContent = 'Errore';
      $('#adminSystemStatus').textContent = 'Errore connessione';
    }finally{
      isUpdatingAdminPanel = false;
      if(btn) btn.classList.remove('refreshing');
    }
  }
  
  // Heartbeat per utente corrente
  function userHeartbeat(){
    if(currentUserData && currentUserData.id){
      updateSharedActivity(currentUserData.id);
    }
  }
  
  // Avvia heartbeat utente
  function startUserHeartbeat(){
    if(userHeartbeatInterval){
      clearInterval(userHeartbeatInterval);
    }
    
    userHeartbeatInterval = setInterval(() => {
      userHeartbeat();
    }, USER_HEARTBEAT_INTERVAL);
    
    // Esegui immediatamente
    userHeartbeat();
  }
  
  // Avvia aggiornamenti admin
  function startAdminUpdates(){
    if(adminUpdateInterval){
      clearInterval(adminUpdateInterval);
    }
    
    adminUpdateInterval = setInterval(() => {
      if($('.page.active')?.id === 'page-admin' && isAdminUser()){
        updateAdminPanel();
      }
    }, ADMIN_UPDATE_INTERVAL);
    
    // Esegui immediatamente
    if($('.page.active')?.id === 'page-admin'){
      updateAdminPanel();
    }
  }
  
  // Ferma aggiornamenti admin
  function stopAdminUpdates(){
    if(adminUpdateInterval){
      clearInterval(adminUpdateInterval);
      adminUpdateInterval = null;
    }
  }
  
  // Gestione pulsante aggiornamento manuale
  $('#adminRefreshBtn')?.addEventListener('click', async () => {
    if(isUpdatingAdminPanel) return;
    
    await updateAdminPanel();
    toast('Pannello admin aggiornato!');
  });

  /* Router */
  function showPage(id){
    if(protectedRoutes.has(id) && !isLoggedIn()){
      toast('Devi effettuare il login per accedere a questa sezione.');
      id = 'home';
    }
    
    if(adminRoutes.has(id) && !isAdminUser()){
      toast('Accesso riservato all\'amministratore.');
      id = 'home';
    }
    
    $$('.page').forEach(p => p.classList.remove('active'));
    $$('.nav-link').forEach(l => l.classList.remove('active'));
    
    $(`#page-${id}`)?.classList.add('active');
    $(`.nav-link[data-route="${id}"]`)?.classList.add('active');
    
    if(id === 'home') tryAutoplay();
    if(id === 'admin' && isAdminUser()){
      updateAdminPanel();
      startAdminUpdates();
    }else if(isAdminUser()){
      stopAdminUpdates();
    }
  }
  
  document.addEventListener('click', e => {
    const r = e.target.closest('[data-route]');
    if(!r) return;
    
    e.preventDefault();
    showPage(r.dataset.route);
  });

  /* Donazioni (testi) */
  const OFFER_TEXT={
    5:"Acquistando questo pacchetto otterai 50.000€ in gioco\n(Aprite un ticket su discord per ricevere le ricompense)",
    10:"Acquistando questo pacchetto otterai 100.000€ in gioco\n(Aprite un ticket su discord per ricevere le ricompense)",
    15:"Acquistando questo pacchetto otterai 100.000€ in gioco\n(Aprite un ticket su discord per ricevere le ricompense)",
    20:"Acquistando questo pacchetto otterai 150.000€ in gioco\n(Aprite un ticket su discord per ricevere le ricompense)",
    30:"Acquistando questo pacchetto otterrai 200.000€ in gioco\n(Aprite un ticket su discord per ricevere le ricompense)",
    40:"Acquistando questo pacchetto otterrai 250.000€ in gioco\n(Aprite un ticket su discord per ricevere le ricompense)",
    50:"Acquistando questo pacchetto otterai 300.000€ in gioco + un'auto a tua scelta (vedere discord)\n(Aprite un ticket su discord per ricevere le ricompense, le auto donatori in caso di wipe rimarranno al giocatore)",
    70:"Acquistando questo pacchetto otterai 400.000€ in gioco\n(Aprite un ticket su discord per ricevere le ricompense)"
  };
  
  $('#donationsGrid')?.addEventListener('click', e => {
    const card = e.target.closest('.donation-card');
    if(!card) return;
    e.preventDefault();
    
    if(!isLoggedIn()){
      toast('Effettua il login per vedere i dettagli delle donazioni.');
      return;
    }
    
    const price = card.dataset.price || '0';
    const img = card.dataset.img || '';
    
    $('#detailTitle').textContent = 'Pacchetto ' + price + '€';
    $('#detailPrice').textContent = price;
    $('#detailImg').src = img;
    $('#detailDesc').textContent = OFFER_TEXT[price] || '';
    showPage('donation');
  });
  
  document.addEventListener('click', e => {
    if(e.target.id === 'btnBackDon'){
      showPage('donations');
    }
    if(e.target.id === 'btnBuy'){
      toast('Pagamento non configurato — apri un ticket su Discord per completare la donazione.');
    }
  });

  /* ===== DISCORD: SOLO NUMERI ===== */
  const DISCORD = { guildId: null, name: 'Community Discord' };

  async function resolveInvite(){
    const data = await fetchWithTimeoutRetry(
      `https://discord.com/api/invites/${encodeURIComponent(INVITE_CODE)}?with_counts=true&with_expiration=false`,
      {}, 6000, 1
    );
    
    DISCORD.guildId = data?.guild?.id || null;
    DISCORD.name = data?.guild?.name || DISCORD.name;
    
    return {
      name: DISCORD.name,
      guildId: DISCORD.guildId,
      approxTotal: data?.approximate_member_count ?? null,
      approxOnline: data?.approximate_presence_count ?? null
    };
  }

  async function getWidgetPresence(guildId){
    if(!guildId) return null;
    
    const w = await fetchWithTimeoutRetry(
      `https://discord.com/api/guilds/${guildId}/widget.json`,
      {}, 6000, 0
    );
    
    return {
      name: w?.name || DISCORD.name,
      presence: Number(w?.presence_count || 0)
    };
  }

  function setCounts({ total, online, name }){
    $('#guildName').textContent = name || 'Community Discord';
    $('#countTotal').textContent = (total ?? '—');
    $('#countOnline').textContent = (online ?? '—');
    
    const d = new Date();
    const pad = n => String(n).padStart(2, '0');
    const last = $('#lastUpdate');
    if(last){
      last.textContent = `Aggiornato alle ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
  }

  async function loadCountsOnce(){
    try{
      const inv = await resolveInvite();
      let online = inv.approxOnline;
      let total = inv.approxTotal;
      
      try{
        const w = await getWidgetPresence(inv.guildId);
        if(w && typeof w.presence === 'number'){
          online = w.presence;
        }
        if(w && w.name){
          DISCORD.name = w.name;
        }
      } catch(_){}
      
      setCounts({ total, online, name: DISCORD.name });
    } catch(_){
      setCounts({ total: null, online: null, name: DISCORD.name });
    }
  }

  let countsTimer = null;
  function startCountsAutoRefresh(){
    if(countsTimer) clearInterval(countsTimer);
    countsTimer = setInterval(loadCountsOnce, 30000);
  }

  /* ===== INIZIALIZZAZIONE ===== */
  window.addEventListener('load', async () => {
    // Inizializza storage condiviso
    initSharedStorage();
    
    // Gestisci redirect OAuth
    await handleOAuthRedirectFragment();
    
    // Aggiorna UI
    updateAuthUI();
    scheduleAutoLogout();
    tryAutoplay();
    
    // Carica contatori Discord
    await loadCountsOnce();
    startCountsAutoRefresh();
    
    // Avvia heartbeat se utente loggato
    if(isLoggedIn()){
      const user = JSON.parse(localStorage.getItem(OAUTH_USER_KEY)||'null');
      if(user && user.id){
        currentUserData = user;
        startUserHeartbeat();
      }
    }
    
    // Se admin, avvia aggiornamenti
    if(isAdminUser()){
      startAdminUpdates();
    }
  });
  
  window.addEventListener('focus', () => {
    scheduleAutoLogout();
    
    // Aggiorna attività quando la finestra diventa attiva
    if(currentUserData && currentUserData.id){
      updateSharedActivity(currentUserData.id);
    }
  });
  
  // Traccia quando l'utente chiude la pagina
  window.addEventListener('beforeunload', () => {
    if(currentUserData && currentUserData.id){
      endSharedSession(currentUserData.id);
    }
    stopAdminUpdates();
    
    if(userHeartbeatInterval){
      clearInterval(userHeartbeatInterval);
      userHeartbeatInterval = null;
    }
  });
  
  // Aggiorna attività quando l'utente interagisce
  document.addEventListener('click', () => {
    if(currentUserData && currentUserData.id){
      updateSharedActivity(currentUserData.id);
    }
  });
  
  document.addEventListener('keydown', () => {
    if(currentUserData && currentUserData.id){
      updateSharedActivity(currentUserData.id);
    }
  });
  
  // Aggiorna attività periodicamente anche se nessuna interazione
  setInterval(() => {
    if(currentUserData && currentUserData.id){
      updateSharedActivity(currentUserData.id);
    }
  }, 30000);

  // Bind login/logout
  $('#btnDiscordLogin')?.addEventListener('click', beginDiscordLogin);
  $('#btnLogout')?.addEventListener('click', logout, {capture: true});

  // Sicurezza postMessage
  window.addEventListener('message', (ev) => {
    if(ev.origin !== originOf(REDIRECT_URI)) return;
  });
  </script>
</body>
</html>
